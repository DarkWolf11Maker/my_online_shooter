<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forest Deathmatch Online</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
body{overflow:hidden;background:#000;font-family:'Share Tech Mono',monospace;}
canvas{display:block;position:fixed;top:0;left:0;z-index:0;}

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:200;background:radial-gradient(ellipse 80% 80% at 50% 40%,#0d2008 0%,#030903 100%);}
.screen.off{display:none!important;}
.logo{font-family:'Oswald',sans-serif;font-size:clamp(2.5rem,8vw,6rem);color:#7fff00;
  text-shadow:0 0 40px #4a9900,0 0 80px #1d4a00;letter-spacing:.15em;line-height:1;text-align:center;}
.logo-sub{color:#3a6020;font-size:.85rem;letter-spacing:.35em;margin-top:.5rem;}
input[type=text]{background:transparent;border:none;border-bottom:2px solid #7fff00;color:#fff;
  font-family:'Share Tech Mono',monospace;font-size:1.3rem;text-align:center;padding:.4rem 1rem;
  width:280px;outline:none;letter-spacing:.1em;margin-top:2rem;}
input[type=text]::placeholder{color:#2a4a18;}
.btn{margin-top:1.4rem;padding:.85rem 3.2rem;font-family:'Oswald',sans-serif;font-size:1.3rem;
  letter-spacing:.2em;background:transparent;border:2px solid #7fff00;color:#7fff00;cursor:pointer;
  text-transform:uppercase;position:relative;overflow:hidden;transition:color .2s;}
.btn::before{content:'';position:absolute;inset:0;background:#7fff00;transform:scaleX(0);transform-origin:left;transition:transform .2s;z-index:-1;}
.btn:hover{color:#000;}.btn:hover::before{transform:scaleX(1);}
.info-box{margin-top:1.8rem;border:1px solid #1a3a0a;padding:1rem 1.8rem;color:#4a7030;font-size:.72rem;line-height:2;max-width:520px;text-align:center;}
.info-box strong{color:#6a9a40;font-family:'Oswald',sans-serif;font-size:.85rem;letter-spacing:.1em;}

/* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hud{position:fixed;inset:0;pointer-events:none;z-index:50;}
#hud.off{display:none!important;}
/* Timer + map */
#timer{position:absolute;top:12px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:1.2rem;letter-spacing:.2em;
  background:rgba(0,0,0,.65);border:1px solid rgba(127,255,0,.35);padding:5px 18px;color:#7fff00;}
#mapbadge{position:absolute;top:12px;left:16px;font-family:'Oswald',sans-serif;font-size:.85rem;
  letter-spacing:.2em;color:#4a7030;background:rgba(0,0,0,.6);border:1px solid #1a3a0a;padding:4px 10px;}
#pcbadge{position:absolute;top:12px;right:16px;font-size:.72rem;color:#4a7030;
  background:rgba(0,0,0,.6);border:1px solid #1a3a0a;padding:4px 10px;}
/* Money */
#money{position:absolute;top:52px;left:16px;font-family:'Oswald',sans-serif;font-size:1rem;
  letter-spacing:.15em;color:#ffd700;text-shadow:0 0 10px #aa8800;
  background:rgba(0,0,0,.6);border:1px solid #554400;padding:4px 12px;}
#money-gain{position:absolute;top:90px;left:16px;font-family:'Oswald',sans-serif;font-size:.85rem;
  letter-spacing:.15em;color:#ffd700;pointer-events:none;opacity:0;transition:opacity .3s;}
/* HP */
#hpbar-wrap{position:absolute;bottom:128px;left:20px;display:flex;flex-direction:column;gap:4px;}
.bar-label{font-size:.65rem;color:#4a7030;letter-spacing:.15em;}
.bar-track{width:190px;height:9px;background:#111;border:1px solid #222;border-radius:2px;overflow:hidden;}
.bar-fill{height:100%;border-radius:2px;transition:width .12s,background .3s;}
#hp-fill{width:100%;background:#44ff44;}
#armor-fill{width:0%;background:#4488ff;}
#livesrow{display:flex;gap:5px;margin-top:2px;}
.lpip{width:13px;height:13px;border-radius:50%;}
/* Kill feed */
#kf{position:absolute;top:56px;right:16px;display:flex;flex-direction:column;align-items:flex-end;gap:4px;max-width:300px;}
.km{font-family:'Oswald',sans-serif;font-size:.78rem;background:rgba(0,0,0,.8);
  border-left:3px solid #7fff00;padding:3px 9px 3px 7px;color:#a0d060;letter-spacing:.07em;
  animation:kmfade 4s forwards;}
@keyframes kmfade{0%{opacity:0;transform:translateX(18px)}8%{opacity:1;transform:none}78%{opacity:1}100%{opacity:0}}
/* Weapon slots */
#wbar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:5px;align-items:flex-end;}
.ws{width:68px;height:68px;border:2px solid #1a3a0a;background:rgba(0,0,0,.75);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
  position:relative;transition:border-color .12s,transform .12s;cursor:pointer;}
.ws.active{border-color:#7fff00;background:rgba(0,22,0,.9);transform:translateY(-5px);box-shadow:0 0 14px rgba(127,255,0,.4);}
.ws.empty{opacity:.28;}
.ws .wi{font-size:1.5rem;line-height:1;}
.ws .wn{font-family:'Oswald',sans-serif;font-size:.52rem;letter-spacing:.08em;color:#7aaa50;}
.ws .wa{font-size:.62rem;color:#aaa;}
.ws .wa.low{color:#ff9900;animation:blink .45s step-end infinite;}
.ws .wa.none{color:#ff3300;}
.ws .wnum{position:absolute;top:3px;left:5px;font-size:.58rem;color:#3a5a20;}
@keyframes blink{50%{opacity:0;}}
/* Minimap */
#mm{position:absolute;bottom:20px;right:20px;width:130px;height:130px;
  border:2px solid #2a4a18;background:rgba(0,0,0,.85);border-radius:2px;}
/* Crosshair */
#ch{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:22px;height:22px;pointer-events:none;z-index:60;}
#ch::before,#ch::after{content:'';position:absolute;background:rgba(255,255,255,.88);}
#ch::before{width:2px;height:22px;left:10px;top:0;}
#ch::after{width:22px;height:2px;left:0;top:10px;}
#ch.knife::before{transform:rotate(45deg);background:#aaffaa;}
#ch.knife::after{transform:rotate(45deg);background:#aaffaa;}
/* Pickup toast */
#ptost{position:fixed;bottom:106px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:1rem;letter-spacing:.18em;color:#ffd700;
  text-shadow:0 0 12px #aa8800;pointer-events:none;z-index:60;opacity:0;transition:opacity .3s;}
#ptost.show{opacity:1;}
/* Pickup hint */
#pickup-hint{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:.88rem;letter-spacing:.22em;color:#7fff00;
  text-shadow:0 0 10px #3a8800;pointer-events:none;z-index:60;opacity:0;transition:opacity .25s;
  background:rgba(0,0,0,.65);border:1px solid rgba(127,255,0,.3);padding:5px 14px;}
#pickup-hint.show{opacity:1;}
/* Drop hint */
#drop-hint{position:fixed;bottom:115px;right:160px;font-family:'Oswald',sans-serif;
  font-size:.68rem;letter-spacing:.15em;color:#888;pointer-events:none;z-index:60;}
/* Click-to-play */
#lock-ov{position:fixed;inset:0;z-index:150;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(0,0,0,.55);pointer-events:all;cursor:pointer;}
#lock-ov.off{display:none!important;}
#lock-ov p{font-family:'Oswald',sans-serif;font-size:1.9rem;letter-spacing:.3em;color:#7fff00;
  text-shadow:0 0 20px #4a9900;animation:lblink 1.5s ease-in-out infinite;}
#lock-ov small{color:#3a5a20;font-size:.8rem;letter-spacing:.2em;margin-top:.6rem;}
@keyframes lblink{0%,100%{opacity:.35;}50%{opacity:1.0;}}
/* Flash hit */
#flash{position:fixed;inset:0;pointer-events:none;z-index:180;opacity:0;background:rgba(255,30,0,.48);}
#flash.pop{animation:fpop .25s ease-out forwards;}
@keyframes fpop{0%{opacity:1;}100%{opacity:0;}}
/* Leaderboard */
#lb-ov{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:100;
  display:flex;align-items:center;justify-content:center;pointer-events:none;}
#lb-ov.off{display:none!important;}
#lb-box{min-width:440px;border:2px solid #7fff00;background:#02080 2;overflow:hidden;}
#lb-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.3em;color:#7fff00;
  background:#031503;padding:11px 18px;border-bottom:1px solid #1a4a0a;text-align:center;}
.lbr{display:flex;border-bottom:1px solid #0d1e08;}
.lbr:last-child{border:none;}
.lbr .rank{width:34px;font-family:'Oswald',sans-serif;font-size:.85rem;color:#3a5a20;text-align:center;padding:9px 0;}
.lbr .nm{flex:1;padding:9px 8px;color:#b0d880;font-size:.82rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lbr .kl{width:50px;text-align:center;padding:9px 0;font-family:'Oswald',sans-serif;color:#7fff00;font-size:.85rem;}
.lbr .dt{width:50px;text-align:center;padding:9px 0;color:#ff5733;font-size:.82rem;}
.lbr .mo{width:60px;text-align:center;padding:9px 0;color:#ffd700;font-size:.75rem;}
.lbr.me{background:rgba(127,255,0,.07);}
.lbr.t1 .nm{color:#ffd700;}.lbr.t1 .rank{color:#ffd700;}
#lb-hint{font-size:.62rem;color:#1a3a08;text-align:center;padding:7px;letter-spacing:.15em;}

/* â”€â”€ SHOP UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#shop-ov{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:110;
  display:flex;align-items:center;justify-content:center;pointer-events:all;}
#shop-ov.off{display:none!important;}
#shop-box{border:2px solid #aa8800;background:#080500;min-width:520px;max-width:620px;overflow:hidden;}
#shop-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.3em;color:#ffd700;
  background:#120900;padding:12px 20px;border-bottom:1px solid #443300;
  display:flex;justify-content:space-between;align-items:center;}
#shop-money-display{font-size:.9rem;color:#ffd700;}
#shop-items{display:grid;grid-template-columns:1fr 1fr;gap:0;}
.shop-item{padding:14px 16px;border:1px solid #221800;cursor:pointer;transition:background .15s;position:relative;}
.shop-item:hover{background:rgba(255,215,0,.06);}
.shop-item.locked{opacity:.45;cursor:not-allowed;}
.shop-item.owned{border-color:#7fff00;background:rgba(0,80,0,.15);cursor:default;}
.shop-item .sname{font-family:'Oswald',sans-serif;font-size:.9rem;letter-spacing:.1em;color:#e0c060;}
.shop-item .sdesc{font-size:.68rem;color:#5a4a20;margin-top:3px;line-height:1.4;}
.shop-item .sprice{font-family:'Oswald',sans-serif;font-size:.85rem;color:#ffd700;margin-top:6px;}
.shop-item .sprice.noafford{color:#aa4400;}
.shop-item .owned-badge{position:absolute;top:8px;right:10px;font-size:.6rem;color:#7fff00;letter-spacing:.1em;font-family:'Oswald',sans-serif;}
#shop-close{background:transparent;border:1px solid #443300;color:#aa8800;font-family:'Oswald',sans-serif;
  font-size:.75rem;letter-spacing:.15em;padding:4px 10px;cursor:pointer;transition:all .15s;}
#shop-close:hover{background:#aa8800;color:#000;}
#shop-feedback{font-size:.72rem;color:#ff5533;text-align:center;padding:8px;letter-spacing:.12em;min-height:28px;}

/* Dead/elim screens */
#dead-screen .dnum{font-family:'Oswald',sans-serif;font-size:5rem;color:#ff5733;
  text-shadow:0 0 30px #ff5733;animation:dpulse 1s ease-in-out infinite;}
@keyframes dpulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
#end-screen table{border-collapse:collapse;min-width:420px;margin-top:1.5rem;}
#end-screen td,#end-screen th{padding:8px 14px;text-align:left;border-bottom:1px solid #1a3a0a;font-size:.82rem;}
#end-screen th{font-family:'Oswald',sans-serif;color:#7fff00;letter-spacing:.12em;font-size:.72rem;}
#end-screen .gold td:first-child,#end-screen .gold td:nth-child(2){color:#ffd700;}
/* Armor indicator */
#armor-bar-wrap{margin-top:2px;}

/* â”€â”€ SCOPE OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scope-ov{position:fixed;inset:0;pointer-events:none;z-index:70;display:none;}
#scope-ov.show{display:block;}
#scope-mask{position:absolute;inset:0;background:#000;}
#scope-lens{position:absolute;top:50%;left:50%;
  width:min(88vh,88vw);height:min(88vh,88vw);
  transform:translate(-50%,-50%);border-radius:50%;
  background:transparent;box-shadow:0 0 0 999px rgba(0,0,0,.97),inset 0 0 60px rgba(0,0,0,.4);
  border:3px solid #444;}
#scope-cross::before,#scope-cross::after{content:'';position:absolute;background:rgba(255,255,255,.8);}
#scope-cross::before{left:50%;top:5%;bottom:5%;width:1px;transform:translateX(-.5px);}
#scope-cross::after{top:50%;left:5%;right:5%;height:1px;transform:translateY(-.5px);}
#scope-cross{position:absolute;inset:0;pointer-events:none;}
#scope-stadia{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:min(88vh,88vw);height:min(88vh,88vw);}
#scope-mil{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  border:1px solid rgba(255,255,255,.25);border-radius:50%;
  width:min(30vh,30vw);height:min(30vh,30vw);}
#scope-label{position:absolute;bottom:8%;left:50%;transform:translateX(-50%);
  font-family:'Share Tech Mono',monospace;font-size:.7rem;letter-spacing:.25em;
  color:rgba(200,255,150,.5);pointer-events:none;}

/* â”€â”€ ADS STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#ads-bar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:.65rem;letter-spacing:.25em;color:#7fff0055;
  pointer-events:none;z-index:60;display:none;}
#ads-bar.show{display:block;}

/* â”€â”€ MAP VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#vote-ov{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:400;
  display:flex;flex-direction:column;align-items:center;justify-content:center;}
#vote-ov.off{display:none!important;}
#vote-title{font-family:'Oswald',sans-serif;font-size:1.6rem;color:#7fff00;
  letter-spacing:.3em;margin-bottom:.4rem;text-align:center;}
#vote-sub{font-family:'Share Tech Mono',monospace;font-size:.8rem;color:#3a6020;
  letter-spacing:.2em;margin-bottom:1.8rem;}
#vote-cards{display:flex;gap:24px;flex-wrap:wrap;justify-content:center;}
.vc{padding:1.6rem 2.2rem;border:2px solid #1a3a0a;background:rgba(0,8,0,.85);
  cursor:pointer;font-family:'Oswald',sans-serif;transition:all .18s;
  min-width:150px;text-align:center;position:relative;}
.vc:hover{border-color:#7fff00;background:rgba(5,25,5,.9);transform:translateY(-3px);}
.vc.voted{border-color:#7fff00;background:rgba(0,50,0,.5);cursor:default;}
.vc .vc-name{font-size:1.1rem;color:#7fff00;letter-spacing:.15em;}
.vc .vc-votes{font-size:2.6rem;color:#fff;margin:.4rem 0;}
.vc .vc-bar{height:4px;background:#7fff00;margin-top:.5rem;transition:width .3s;}
.vc .vc-pct{font-size:.65rem;color:#3a6020;margin-top:.3rem;}
#vote-timer-bar{width:320px;height:4px;background:#1a3a0a;margin-top:1.8rem;border-radius:2px;overflow:hidden;}
#vote-timer-fill{height:100%;background:#7fff00;transition:width 1s linear;}
#vote-timer-txt{font-family:'Oswald',sans-serif;font-size:.85rem;color:#4a7030;
  letter-spacing:.25em;margin-top:.4rem;}
</style>
</head>
<body>

<!-- JOIN -->
<div id="join-screen" class="screen">
  <div class="logo">FOREST<br>DEATHMATCH</div>
  <div class="logo-sub">ONLINE Â· 3D Â· UP TO 50 PLAYERS Â· 6 MAPS</div>
  <input type="text" id="nameInput" maxlength="20" placeholder="ENTER YOUR NAME" autocomplete="off">
  <button class="btn" id="joinBtn">JOIN MATCH</button>
  <div class="info-box">
    <strong>CONTROLS</strong><br>
    WASD / MOVE &nbsp;Â·&nbsp; MOUSE / AIM &nbsp;Â·&nbsp; LMB / SHOOT &amp; ATTACK &nbsp;Â·&nbsp; <strong style="color:#88ffcc">RMB / AIM DOWN SIGHTS</strong><br>
    G / GRENADE &nbsp;Â·&nbsp; Q or SCROLL / SWITCH WEAPON &nbsp;Â·&nbsp; 1â€“7 / SELECT SLOT<br>
    <strong style="color:#7fff00">E / PICK UP GUN</strong> &nbsp;Â·&nbsp; <strong style="color:#ff9900">X / DROP GUN</strong> &nbsp;Â·&nbsp; TAB / LEADERBOARD &nbsp;Â·&nbsp; <strong style="color:#ffd700">F / SHOP</strong> &nbsp;Â·&nbsp; ESC / UNLOCK MOUSE<br><br>
    <strong>ECONOMY</strong> â€” Earn $150 per kill Â· $50 per assist<br>
    Open shop (F) to buy Armor, Speed, Grenades, Stimpacks &amp; more<br><br>
    <strong>MAPS</strong> â€” Forest Â· City Â· Warehouse Â· Desert Â· Arctic Â· Rooftop
  </div>
</div>

<!-- CONNECTING -->
<div id="conn-screen" class="screen off">
  <div class="logo" style="font-size:2rem;animation:lblink 1s ease-in-out infinite">CONNECTING...</div>
</div>

<!-- DEAD -->
<div id="dead-screen" class="screen off">
  <div style="font-family:'Oswald',sans-serif;font-size:1.1rem;color:#ff5733;letter-spacing:.3em">YOU DIED</div>
  <div class="dnum" id="respawnNum">3</div>
  <div style="color:#3a5a20;font-size:.78rem;letter-spacing:.2em">RESPAWNING...</div>
  <div id="livesLeft" style="margin-top:.7rem;color:#6a7a5a;font-size:.72rem;letter-spacing:.2em"></div>
</div>

<!-- ELIMINATED -->
<div id="elim-screen" class="screen off">
  <div class="logo" style="color:#ff5733;font-size:3rem">ELIMINATED</div>
  <div style="color:#4a5a30;font-size:.82rem;letter-spacing:.2em;margin-top:1rem">NO LIVES REMAINING</div>
  <div id="elimStats" style="color:#7aaa50;margin-top:1.5rem;font-size:.88rem;text-align:center;line-height:2"></div>
</div>

<!-- MATCH END -->
<div id="end-screen" class="screen off">
  <div class="logo" style="font-size:2.5rem">MATCH OVER</div>
  <div id="endWinner" style="font-family:'Oswald',sans-serif;font-size:1.4rem;color:#ffd700;letter-spacing:.2em;margin-top:.7rem"></div>
  <table id="endTable"><thead><tr><th>#</th><th>PLAYER</th><th>KILLS</th><th>DEATHS</th><th>$</th></tr></thead><tbody></tbody></table>
  <button class="btn" id="replayBtn" style="margin-top:1.5rem">FIND NEW MATCH</button>
</div>

<!-- HUD -->
<div id="hud" class="off">
  <div id="timer">10:00</div>
  <div id="mapbadge">FOREST</div>
  <div id="pcbadge">ğŸ‘¤ 1</div>
  <div id="money">ğŸ’° $200</div>
  <div id="money-gain"></div>
  <div id="kf"></div>
  <div id="hpbar-wrap">
    <div class="bar-label">HP</div>
    <div class="bar-track"><div class="bar-fill" id="hp-fill"></div></div>
    <div id="armor-bar-wrap">
      <div class="bar-label">ARMOR</div>
      <div class="bar-track"><div class="bar-fill" id="armor-fill"></div></div>
    </div>
    <div id="livesrow"></div>
  </div>
  <div id="wbar"></div>
  <canvas id="mm" width="130" height="130"></canvas>
</div>

<!-- LEADERBOARD OVERLAY -->
<div id="lb-ov" class="off">
  <div id="lb-box">
    <div id="lb-title">âš” LEADERBOARD</div>
    <div id="lb-rows"></div>
    <div id="lb-hint">TAB TO CLOSE</div>
  </div>
</div>

<!-- SHOP OVERLAY -->
<div id="shop-ov" class="off">
  <div id="shop-box">
    <div id="shop-title">
      <span>ğŸ›’ SHOP</span>
      <span id="shop-money-display">ğŸ’° $0</span>
      <button id="shop-close">âœ• CLOSE (F)</button>
    </div>
    <div id="shop-items"></div>
    <div id="shop-feedback"></div>
  </div>
</div>

<!-- MISC -->
<div id="lock-ov" class="off"><p>CLICK TO PLAY</p><small>MOUSE LOOK ENABLED INSIDE GAME</small></div>
<div id="ch"></div>
<div id="flash"></div>
<div id="ptost"></div>
<div id="pickup-hint"></div>
<div id="drop-hint">[X] DROP</div>

<!-- SCOPE OVERLAY -->
<div id="scope-ov">
  <div id="scope-mask"></div>
  <div id="scope-lens"></div>
  <div id="scope-cross"></div>
  <div id="scope-mil"></div>
  <div id="scope-label">âŠ• 10Ã— MAGNIFICATION</div>
</div>

<!-- ADS INDICATOR -->
<div id="ads-bar">â— ADS</div>

<!-- MAP VOTE OVERLAY -->
<div id="vote-ov" class="off">
  <div id="vote-title">ğŸ—º VOTE FOR NEXT MAP</div>
  <div id="vote-sub">CLICK TO VOTE â€” MAJORITY WINS</div>
  <div id="vote-cards"></div>
  <div id="vote-timer-bar"><div id="vote-timer-fill" style="width:100%"></div></div>
  <div id="vote-timer-txt">20s</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEAPON / SHOP DEFINITIONS (client mirror)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WI  = { fists:'ğŸ‘Š',knife:'ğŸ”ª',grenade:'ğŸ’£',pistol:'ğŸ”«',shotgun:'ğŸ’¥',rifle:'ğŸ¯',smg:'âš¡',sniper:'ğŸ¯',minigun:'ğŸ”¥',crossbow:'ğŸ¹',rocket:'ğŸš€',flamethrower:'ğŸ”¥',ammo:'ğŸ’' };
const WN  = { fists:'FISTS',knife:'KNIFE',grenade:'GRENADE',pistol:'PISTOL',shotgun:'SHOTGUN',rifle:'RIFLE',smg:'SMG',sniper:'SNIPER',minigun:'MINIGUN',crossbow:'CROSSBOW',rocket:'ROCKET',flamethrower:'FLAMER',ammo:'AMMO' };
const WCD = { fists:450,knife:380,grenade:800,pistol:340,shotgun:680,rifle:120,smg:75,sniper:900,minigun:45,crossbow:950,rocket:2200,flamethrower:60 };
const WMAX= { pistol:12,shotgun:8,rifle:30,smg:45,sniper:5,minigun:120,crossbow:8,rocket:4,flamethrower:80 };
const WTYPE={ fists:'melee',knife:'melee',grenade:'throw',pistol:'gun',shotgun:'gun',rifle:'gun',smg:'gun',sniper:'gun',minigun:'gun',crossbow:'gun',rocket:'rocket',flamethrower:'gun' };
const WBCOLOR={ pistol:0xffee00,shotgun:0xff8800,rifle:0x00ffcc,smg:0xcc88ff,sniper:0xffffff,minigun:0xffaa00,crossbow:0x88ff44,rocket:0xff4400,flamethrower:0xff6600 };

const SHOP_DEFS = {
  armor:       { price:200, name:'Armor Vest',   icon:'ğŸ›¡', desc:'Absorbs 25% damage',          type:'upgrade' },
  heavy_armor: { price:400, name:'Heavy Armor',  icon:'âš”', desc:'Absorbs 50% damage',          type:'upgrade', requires:'armor' },
  speed:       { price:150, name:'Speed Boost',  icon:'ğŸ’¨', desc:'Move 25% faster permanently',  type:'upgrade' },
  health_kit:  { price:80,  name:'Health Kit',   icon:'â¤', desc:'Instantly restore 50 HP',      type:'consumable' },
  gren_pack:   { price:100, name:'Grenade Pack', icon:'ğŸ’£', desc:'Receive +2 grenades',          type:'consumable' },
  ammo_crate:  { price:120, name:'Ammo Crate',   icon:'ğŸ’', desc:'Refill all gun ammo fully',    type:'consumable' },
  stimpack:    { price:180, name:'Stimpack',     icon:'ğŸ’Š', desc:'Regenerate HP for 12 seconds', type:'consumable' },
  radar:       { price:250, name:'Radar',        icon:'ğŸ“¡', desc:'Always see enemies on minimap', type:'upgrade' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene    = new THREE.Scene();
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.insertBefore(renderer.domElement, document.body.firstChild);

const camera = new THREE.PerspectiveCamera(72, window.innerWidth / window.innerHeight, 0.1, 500);

window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA SYSTEM â€” First-Person Shooter
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let camYaw   = 0;     // horizontal look angle
let camPitch = 0;     // vertical look angle (-up, +down)
const CAM_MIN_PITCH = -1.4;   // look almost straight up
const CAM_MAX_PITCH =  1.4;   // look almost straight down
const FPS_EYE_H = 1.52;       // eye height above ground

// ADS (Aim Down Sights)
let isADS = false;
const FOV_NORMAL = 72;
const FOV_ADS    = 42;
const FOV_SNIPER = 14;

const camPos    = new THREE.Vector3();
const camTarget = new THREE.Vector3(); // used only for minimap

function updateCamera(dt) {
  if (!gameActive) return;
  // FPS: camera sits at player's eye position
  const tx = myX, ty = FPS_EYE_H, tz = myZ;
  camPos.lerp(new THREE.Vector3(tx, ty, tz), Math.min(1, dt * 0.4));
  camera.position.copy(camPos);
  // Look direction from yaw + pitch
  const dx = -Math.sin(camYaw) * Math.cos(camPitch);
  const dy = -Math.sin(camPitch);
  const dz = -Math.cos(camYaw) * Math.cos(camPitch);
  camera.lookAt(camPos.x + dx * 500, camPos.y + dy * 500, camPos.z + dz * 500);
}

// Aim angle = direction camera is looking, projected to XZ plane
function getAimAngle() {
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  return Math.atan2(dir.x, dir.z);
}

// Snap camera instantly (on spawn / respawn)
function snapCamera() {
  camPos.set(myX, FPS_EYE_H, myZ);
  camera.position.copy(camPos);
  const dx = -Math.sin(camYaw), dz = -Math.cos(camYaw);
  camera.lookAt(myX + dx * 100, FPS_EYE_H, myZ + dz * 100);
}

// ADS
function startADS() {
  if (!isLocked || !gameActive || myDead || isShopOpen) return;
  isADS = true;
  const wkey = myInventory[myWepIdx]?.key;
  if (wkey === 'sniper') {
    camera.fov = FOV_SNIPER;
    document.getElementById('scope-ov').classList.add('show');
    document.getElementById('ch').style.display = 'none';
  } else {
    camera.fov = FOV_ADS;
    document.getElementById('ads-bar').classList.add('show');
  }
  camera.updateProjectionMatrix();
}

function stopADS() {
  isADS = false;
  camera.fov = FOV_NORMAL;
  camera.updateProjectionMatrix();
  document.getElementById('scope-ov').classList.remove('show');
  document.getElementById('ads-bar').classList.remove('show');
  document.getElementById('ch').style.display = '';
}

// Called in updateCamera replaced above â€” also need legacy calcCamPosition for respawn compat
function calcCamPosition(px, pz, yaw, pitch, dist) {
  return { x: px, y: FPS_EYE_H, z: pz };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupLighting(mapName) {
  scene.children.filter(c => c.isLight).forEach(c => scene.remove(c));
  const configs = {
    forest:    { bg:0x0d1a07, fog:['exp2',0x0d1a07,0.020], amb:[0x223322,0.8], sun:[0x99cc66,1.3,25,50,15] },
    city:      { bg:0x0a1018, fog:['lin',0x111820,30,120],  amb:[0x223344,0.6], sun:[0xaabbcc,0.9,-20,50,10] },
    warehouse: { bg:0x080d08, fog:['lin',0x0a0f0a,20,80],   amb:[0x334433,0.5], sun:[0xbbddaa,0.7,0,50,0] },
    desert:    { bg:0x2a1e0a, fog:['exp2',0x3a2810,0.014],  amb:[0x554422,0.9], sun:[0xffcc88,1.5,30,60,20] },
    arctic:    { bg:0x1a2435, fog:['exp2',0x8899bb,0.022],  amb:[0x4466aa,0.7], sun:[0xaaccff,1.0,-10,45,5] },
    rooftop:   { bg:0x080c12, fog:['lin',0x101520,40,160],  amb:[0x222233,0.6], sun:[0x8899bb,0.8,20,50,-10] },
  };
  const cfg = configs[mapName] || configs.forest;
  scene.background = new THREE.Color(cfg.bg);
  if (cfg.fog[0] === 'exp2') scene.fog = new THREE.FogExp2(cfg.fog[1], cfg.fog[2]);
  else scene.fog = new THREE.Fog(cfg.fog[1], cfg.fog[2], cfg.fog[3]);
  scene.add(new THREE.AmbientLight(cfg.amb[0], cfg.amb[1]));
  const sun = new THREE.DirectionalLight(cfg.sun[0], cfg.sun[1]);
  sun.position.set(cfg.sun[2], cfg.sun[3], cfg.sun[4]);
  sun.castShadow = true;
  sun.shadow.mapSize.width = sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.left = sun.shadow.camera.bottom = -75;
  sun.shadow.camera.right = sun.shadow.camera.top = 75;
  sun.shadow.camera.near = 0.1; sun.shadow.camera.far = 250;
  scene.add(sun);
  // Map-specific atmosphere
  if (mapName === 'city' || mapName === 'rooftop') {
    const lamps = [[-20,-20],[-20,20],[20,-20],[20,20],[0,0],[-10,0],[10,0],[0,-10],[0,10],[-30,0],[30,0],[0,-30],[0,30]];
    for (const [lx,lz] of lamps) { const pl=new THREE.PointLight(mapName==='city'?0xff8844:0x4488ff,1.4,20); pl.position.set(lx,7,lz); scene.add(pl); }
  }
  if (mapName === 'warehouse') {
    const lps=[[-15,-15],[15,-15],[-15,15],[15,15],[0,0],[-15,0],[15,0],[0,-15],[0,15]];
    for (const [lx,lz] of lps){const pl=new THREE.PointLight(0xddffcc,1.1,22);pl.position.set(lx,9,lz);scene.add(pl);}
  }
  if (mapName === 'arctic') {
    scene.add(new THREE.HemisphereLight(0x8899bb, 0xaabbdd, 0.4));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP OBJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mapObjs = [];
let colliders = []; // {x, z, r}

function clearMap() { mapObjs.forEach(o => scene.remove(o)); mapObjs=[]; colliders=[]; }

function addMap(obj) { scene.add(obj); mapObjs.push(obj); return obj; }

const mkM = (geo, color, cast=true, recv=true) => {
  const m = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({ color }));
  m.castShadow = cast; m.receiveShadow = recv; return m;
};

// â”€â”€ FOREST â”€â”€
function buildForest() {
  setupLighting('forest');
  const gnd = mkM(new THREE.PlaneGeometry(130,130,40,40), 0x1a3510, false, true);
  gnd.rotation.x = -Math.PI/2;
  const pos = gnd.geometry.attributes.position;
  for (let i=0;i<pos.count;i++) pos.setY(i,(Math.random()-.5)*.15);
  gnd.geometry.computeVertexNormals();
  addMap(gnd);
  for (let i=0;i<72;i++){const a=(i/72)*Math.PI*2,r=48+(Math.random()-.5)*4;placeTree(Math.cos(a)*r,Math.sin(a)*r,1.0+Math.random()*.8);}
  let pl2=0,tr=0;
  while(pl2<65&&tr<3500){tr++;const x=(Math.random()-.5)*88,z=(Math.random()-.5)*88;if(Math.hypot(x,z)>48||(Math.abs(x)<10&&Math.abs(z)<10))continue;const s=.7+Math.random()*1.2;if(colliders.every(t=>Math.hypot(x-t.x,z-t.z)>t.r+s*1.0+.8)){placeTree(x,z,s);pl2++;}}
  for (let i=0;i<55;i++){const x=(Math.random()-.5)*90,z=(Math.random()-.5)*90;if(Math.hypot(x,z)>50)continue;const s=.4+Math.random()*.7;const b=mkM(new THREE.SphereGeometry(s,6,5),new THREE.Color().setHSL(0.3,.55,.07+Math.random()*.06).getHex());b.scale.y=.6;b.position.set(x,s*.3,z);addMap(b);}
}
function placeTree(x,z,s) {
  const g=new THREE.Group();
  const t=mkM(new THREE.CylinderGeometry(.18*s,.3*s,1.6*s,7),0x3d2200);t.position.y=.8*s;g.add(t);
  for(let i=0;i<3;i++){const h=(1.9-i*.4)*s,r=(1.2-i*.18)*s,leaf=mkM(new THREE.ConeGeometry(r,h,7),[0x1a4208,0x22550e,0x2a6212][i]);leaf.position.y=(1.6+i*.9+h*.5)*s;g.add(leaf);}
  g.position.set(x,0,z);g.rotation.y=Math.random()*Math.PI*2;addMap(g);colliders.push({x,z,r:.55*s});
}

// â”€â”€ CITY â”€â”€
function buildCity() {
  setupLighting('city');
  addMap(mkM(new THREE.PlaneGeometry(130,130),0x111418,false,true)).rotation.x=-Math.PI/2;
  const bldgs=[[-30,-30,12,12,14,0x223040],[-30,30,10,14,18,0x1a2535],[30,-30,14,10,12,0x2a3545],[30,30,12,12,20,0x1e2c3a],
    [-30,0,10,8,10,0x243040],[30,0,8,10,16,0x1c2838],[0,-30,14,8,11,0x2a3040],[0,30,8,14,15,0x1e2c3a],
    [-15,-15,7,7,8,0x283545],[15,15,7,7,9,0x223040],[-15,15,7,7,12,0x1a2535],[15,-15,7,7,7,0x2a3545],
    [-44,-20,10,16,16,0x1c2838],[-44,20,10,14,22,0x243040],[44,-20,10,16,14,0x223040],[44,20,10,14,18,0x1e2c3a],
    [-20,-44,16,10,12,0x2a3545],[20,-44,14,10,10,0x1a2535],[-20,44,16,10,18,0x283545],[20,44,14,10,14,0x223040]];
  for(const [x,z,w,d,h,c] of bldgs){const b=mkM(new THREE.BoxGeometry(w,h,d),c);b.position.set(x,h/2,z);addMap(b);
    for(let wy=2;wy<h-1;wy+=3)for(let wx=-w/2+1.5;wx<w/2;wx+=3){const win=mkM(new THREE.BoxGeometry(1.2,1.4,.12),Math.random()>.3?0x334455:0xaabbcc);win.position.set(x+wx,wy+.5,z+d/2+.06);addMap(win);}
    colliders.push({x,z,r:Math.max(w,d)/2*.95});}
  const cars=[[-8,-20],[8,-20],[-8,20],[8,20],[-20,-8],[-20,8],[20,-8],[20,8],[-12,-30],[12,30]];
  for(const[cx,cz]of cars){const car=new THREE.Group();const body=mkM(new THREE.BoxGeometry(2.2,1.0,4.2),0x334455);body.position.y=.5;car.add(body);const roof=mkM(new THREE.BoxGeometry(1.8,.7,2.4),0x2a3848);roof.position.y=1.35;car.add(roof);const wheel=mkM(new THREE.CylinderGeometry(.3,.3,.2,8),0x111111);wheel.rotation.z=Math.PI/2;[[-.9,.25,1.4],[.9,.25,1.4],[-.9,.25,-1.4],[.9,.25,-1.4]].forEach(([wx,wy,wz])=>{const wc=wheel.clone();wc.position.set(wx,wy,wz);car.add(wc);});car.position.set(cx,0,cz);car.rotation.y=Math.random()>.5?0:Math.PI/2;addMap(car);colliders.push({x:cx,z:cz,r:1.8});}
}

// â”€â”€ WAREHOUSE â”€â”€
function buildWarehouse() {
  setupLighting('warehouse');
  addMap(mkM(new THREE.PlaneGeometry(100,100),0x1a1e1a,false,true)).rotation.x=-Math.PI/2;
  const wc=0x2a302a,wh=14;
  [[0,wh/2,-46,96,wh,1],[0,wh/2,46,96,wh,1],[-46,wh/2,0,1,wh,92],[46,wh/2,0,1,wh,92]].forEach(([x,y,z,w,h,d])=>{const w2=mkM(new THREE.BoxGeometry(w,h,d),wc);w2.position.set(x,y,z);addMap(w2);});
  for(let x=-30;x<=30;x+=15)for(let z=-30;z<=30;z+=15){if(Math.abs(x)<8&&Math.abs(z)<8)continue;const p=mkM(new THREE.CylinderGeometry(.4,.4,wh,8),0x3a4038);p.position.set(x,wh/2,z);addMap(p);colliders.push({x,z,r:.65});}
  const cpos=[[-20,-20],[-20,20],[20,-20],[20,20],[-10,-10],[10,10],[-10,10],[10,-10],[-25,0],[25,0],[0,-25],[0,25],[-18,-5],[18,5],[-5,18],[5,-18]];
  for(const[cx,cz]of cpos){const sh=1+Math.floor(Math.random()*3);for(let h=0;h<sh;h++){const w2=2.2+Math.random()*.6;const cr=mkM(new THREE.BoxGeometry(w2,2,w2),0x4a4030);cr.position.set(cx+(Math.random()-.5)*.5,1+h*2,cz+(Math.random()-.5)*.5);const l1=mkM(new THREE.BoxGeometry(w2+.02,.08,.08),0x5a5040,false);const l2=mkM(new THREE.BoxGeometry(.08,.08,w2+.02),0x5a5040,false);l1.position.set(cx,1+h*2,cz);l2.position.set(cx,1+h*2,cz);addMap(l1);addMap(l2);addMap(cr);}colliders.push({x:cx,z:cz,r:1.7});}
  const cw=mkM(new THREE.BoxGeometry(40,.4,4),0x353830);cw.position.set(0,6,0);addMap(cw);
  for(let rx=-20;rx<=20;rx+=2){const rl=mkM(new THREE.CylinderGeometry(.06,.06,1.2,5),0x444840);rl.position.set(rx,6.8,2);addMap(rl);const rl2=rl.clone();rl2.position.set(rx,6.8,-2);addMap(rl2);}
  const ramp=mkM(new THREE.BoxGeometry(3,.3,8),0x353830);ramp.rotation.x=-.7;ramp.position.set(-22,3,-1);addMap(ramp);
}

// â”€â”€ DESERT â”€â”€
function buildDesert() {
  setupLighting('desert');
  // Sandy ground with subtle displacement
  const gnd=mkM(new THREE.PlaneGeometry(130,130,40,40),0x8b6b3a,false,true);gnd.rotation.x=-Math.PI/2;
  const dp=gnd.geometry.attributes.position;for(let i=0;i<dp.count;i++)dp.setY(i,(Math.random()-.5)*.2);
  gnd.geometry.computeVertexNormals();addMap(gnd);
  // Ruined stone columns
  const colPos=[[-20,-15],[20,-15],[-20,15],[20,15],[0,-20],[0,20],[-30,0],[30,0],[-12,0],[12,0],[0,0],[-25,-25],[25,25],[-25,25],[25,-25]];
  for(const[cx,cz]of colPos){const h=3+Math.random()*5;const broken=Math.random()>.5;
    const col=mkM(new THREE.CylinderGeometry(.6,.75,h,7),0x8a7050);col.position.set(cx,h/2,cz);addMap(col);
    if(broken){const topH=1+Math.random()*2;const frag=mkM(new THREE.CylinderGeometry(.5,.6,topH,7),0x7a6040);frag.position.set(cx+(Math.random()-.5)*1.5,h+topH*.5,cz+(Math.random()-.5)*1.5);frag.rotation.z=(Math.random()-.5)*.5;addMap(frag);}
    colliders.push({x:cx,z:cz,r:.8});}
  // Ruined walls
  const walls=[[-35,0,4,12,1],[35,0,4,12,1],[0,-35,12,4,1],[0,35,12,4,1]];
  for(const[wx,wz,ww,wd,_]of walls){for(let s=0;s<3;s++){const seg=mkM(new THREE.BoxGeometry(ww/3-.2,2+Math.random()*2,wd),0x7a6040);seg.position.set(wx+(s-1)*(ww/3),seg.geometry.parameters.height/2,wz);seg.rotation.y=(Math.random()-.5)*.1;addMap(seg);}colliders.push({x:wx,z:wz,r:Math.max(ww,wd)*.4});}
  // Sand dunes (visual only)
  for(let i=0;i<12;i++){const x=(Math.random()-.5)*80,z=(Math.random()-.5)*80;const s=3+Math.random()*4;const dune=mkM(new THREE.SphereGeometry(s,8,5),0xaa8850);dune.scale.y=.25;dune.position.set(x,s*.12,z);addMap(dune);}
  // Oasis palm trees in center area
  for(let i=0;i<8;i++){const a=i/8*Math.PI*2,r=8+Math.random()*4;placePalmTree(Math.cos(a)*r,Math.sin(a)*r);}
}
function placePalmTree(x,z){
  const g=new THREE.Group();
  const trunk=mkM(new THREE.CylinderGeometry(.18,.28,4,6),0x5a3a10);trunk.position.y=2;g.add(trunk);
  const crown=mkM(new THREE.SphereGeometry(1.8,8,6),0x2a6010);crown.scale.y=.5;crown.position.y=4.5;g.add(crown);
  g.position.set(x,0,z);g.rotation.y=Math.random()*Math.PI*2;addMap(g);colliders.push({x,z,r:.5});
}

// â”€â”€ ARCTIC â”€â”€
function buildArctic() {
  setupLighting('arctic');
  // Snow ground
  const gnd=mkM(new THREE.PlaneGeometry(130,130,40,40),0xdde8f0,false,true);gnd.rotation.x=-Math.PI/2;
  const ap=gnd.geometry.attributes.position;for(let i=0;i<ap.count;i++)ap.setY(i,(Math.random()-.5)*.08);
  gnd.geometry.computeVertexNormals();addMap(gnd);
  // Snow drifts
  for(let i=0;i<25;i++){const x=(Math.random()-.5)*90,z=(Math.random()-.5)*90;const s=2+Math.random()*4;const drift=mkM(new THREE.SphereGeometry(s,8,5),0xe8f0f8);drift.scale.y=.22;drift.position.set(x,s*.11,z);addMap(drift);}
  // Ice rocks/boulders
  const bpos=[[-20,-15],[20,-15],[-20,15],[20,15],[0,-20],[0,20],[-30,0],[30,0],[0,0],[-14,14],[14,-14],[-14,-14],[14,14],[-25,-10],[25,10]];
  for(const[bx,bz]of bpos){const h=1.5+Math.random()*2.5;const b=mkM(new THREE.DodecahedronGeometry(h*.7,0),0x8aaccc);b.position.set(bx,h*.35,bz);b.rotation.y=Math.random()*Math.PI*2;addMap(b);colliders.push({x:bx,z:bz,r:h*.55});}
  // Frozen pine trees
  for(let i=0;i<40;i++){const x=(Math.random()-.5)*90,z=(Math.random()-.5)*90;if(Math.hypot(x,z)>52||(Math.abs(x)<10&&Math.abs(z)<10))continue;const s=.7+Math.random()*1.0;placeSnowTree(x,z,s);}
}
function placeSnowTree(x,z,s){
  const g=new THREE.Group();
  const t=mkM(new THREE.CylinderGeometry(.12*s,.2*s,1.4*s,6),0x3d2200);t.position.y=.7*s;g.add(t);
  for(let i=0;i<3;i++){const h=(1.5-i*.3)*s,r=(1.0-i*.15)*s;const cone=mkM(new THREE.ConeGeometry(r,h,6),i%2===0?0x1a4208:0xdde8f0);cone.position.y=(1.4+i*.8+h*.5)*s;g.add(cone);}
  g.position.set(x,0,z);g.rotation.y=Math.random()*Math.PI*2;addMap(g);colliders.push({x,z,r:.5*s});
}

// â”€â”€ ROOFTOP â”€â”€
function buildRooftop() {
  setupLighting('rooftop');
  // Main rooftop platforms
  const platforms=[
    [0,0,60,60,.6,0x2a2e36],    // Main roof
    [-25,2,12,12,.6,0x222630],  // Sub-roof left
    [25,2,12,12,.6,0x222630],   // Sub-roof right
    [0,2,10,20,.6,0x222630],    // Sub-roof center
    [-35,1.4,10,8,.6,0x1e2230], [35,1.4,10,8,.6,0x1e2230],
  ];
  for(const[px,py,pw,pd,ph,pc]of platforms){const pl=mkM(new THREE.BoxGeometry(pw,ph,pd),pc,false,true);pl.position.set(px,py-.3,0);addMap(pl);}
  // Main floor
  addMap(mkM(new THREE.PlaneGeometry(60,60),0x22262e,false,true)).rotation.x=-Math.PI/2;
  // AC units
  const acPos=[[-15,-15],[15,-15],[15,15],[-15,15],[0,-20],[0,20],[-8,0],[8,0]];
  for(const[ax,az]of acPos){const ac=new THREE.Group();const body=mkM(new THREE.BoxGeometry(2.5,1.4,1.8),0x334040);body.position.y=.7;ac.add(body);const fan=mkM(new THREE.CylinderGeometry(.5,.5,.25,8),0x223030);fan.rotation.x=Math.PI/2;fan.position.set(0,.8,.9);ac.add(fan);ac.position.set(ax,0,az);addMap(ac);colliders.push({x:ax,z:az,r:1.4});}
  // Vents/ducts
  const vPos=[[-22,0],[22,0],[0,-22],[0,22],[-12,-8],[12,8]];
  for(const[vx,vz]of vPos){const v=mkM(new THREE.BoxGeometry(1.5,.8,4),0x2a3038);v.position.set(vx,.4,vz);addMap(v);colliders.push({x:vx,z:vz,r:1.5});}
  // Water towers
  const wtPos=[[-28,-28],[28,28],[-28,28]];
  for(const[wx,wz]of wtPos){const tank=mkM(new THREE.CylinderGeometry(1.8,1.8,3,12),0x3a3028);tank.position.set(wx,3.5,wz);addMap(tank);const legs=mkM(new THREE.CylinderGeometry(.12,.12,3,5),0x2a2820);for(const la of[0,1,2,3]){const l2=legs.clone();l2.position.set(wx+Math.cos(la*Math.PI/2)*1.5,1.5,wz+Math.sin(la*Math.PI/2)*1.5);addMap(l2);}colliders.push({x:wx,z:wz,r:2.2});}
  // Roof edge railings
  for(let i=-28;i<=28;i+=3){for(const ez of[-29,29]){const rp=mkM(new THREE.CylinderGeometry(.06,.06,1.2,4),0x3a3e44);rp.position.set(i,.6,ez);addMap(rp);}for(const ex of[-29,29]){const rp=mkM(new THREE.CylinderGeometry(.06,.06,1.2,4),0x3a3e44);rp.position.set(ex,.6,i);addMap(rp);}}
  // Night city background boxes (visual only)
  for(let i=0;i<30;i++){const bx=(Math.random()-.5)*200+((Math.random()>.5)?80:-80),bz=(Math.random()-.5)*200,bh=10+Math.random()*50,bw=5+Math.random()*10;const bldg=mkM(new THREE.BoxGeometry(bw,bh,bw),new THREE.Color().setHSL(.6,.15,.06+Math.random()*.04).getHex());bldg.position.set(bx,bh/2,bz);addMap(bldg);}
}

function buildMap(mapName) {
  clearMap();
  if (mapName==='forest') buildForest();
  else if (mapName==='city') buildCity();
  else if (mapName==='warehouse') buildWarehouse();
  else if (mapName==='desert') buildDesert();
  else if (mapName==='arctic') buildArctic();
  else if (mapName==='rooftop') buildRooftop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PC_COLORS = { pistol:0xffee00,shotgun:0xff8800,rifle:0x00ffcc,smg:0xcc88ff,sniper:0xffffff,minigun:0xff8800,crossbow:0x88ff44,rocket:0xff4400,flamethrower:0xff6600,ammo:0x00ff88 };
const pickupMeshes = new Map();

function mkPickupMesh(pk) {
  const g = new THREE.Group();
  const col = PC_COLORS[pk.type] || 0xffffff;
  const plat = new THREE.Mesh(new THREE.CylinderGeometry(.62,.62,.12,12), new THREE.MeshLambertMaterial({ color:col, emissive:new THREE.Color(col).multiplyScalar(.3) }));
  g.add(plat);
  const geoBody = pk.type==='ammo' ? new THREE.BoxGeometry(.5,.4,.7) : new THREE.BoxGeometry(.14,.12,.42);
  const body = new THREE.Mesh(geoBody, new THREE.MeshLambertMaterial({color:pk.type==='ammo'?0x225522:0x222222}));
  body.position.y=.44; g.add(body);
  const ring = new THREE.Mesh(new THREE.TorusGeometry(.72,.05,5,22), new THREE.MeshBasicMaterial({color:col}));
  ring.rotation.x=-Math.PI/2; g.add(ring);
  const pl=new THREE.PointLight(col,1.4,5); g.add(pl);
  // Weapon icon label (for icon above)
  const topSph=new THREE.Mesh(new THREE.SphereGeometry(.12,5,5),new THREE.MeshBasicMaterial({color:col}));
  topSph.position.y=.85; g.add(topSph);
  g.position.set(pk.x, .7, pk.z);
  scene.add(g); pickupMeshes.set(pk.id, { group:g, x:pk.x, z:pk.z, type:pk.type });
}

function removePickupMesh(id) { const p=pickupMeshes.get(id); if(p){scene.remove(p.group);pickupMeshes.delete(id);} }

function animPickups() {
  const t=Date.now()*.001;
  for(const[,p]of pickupMeshes){p.group.position.y=.6+Math.sin(t*1.4+p.x)*.18;p.group.rotation.y=t*.85;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChar(teamColor, isMe) {
  const g = new THREE.Group();
  const mk2 = (geo, col) => { const m=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));m.castShadow=true;return m; };
  const dark = new THREE.Color(teamColor).multiplyScalar(.5).getHex();
  const skin = 0xe8c090;

  // Boots
  const bL=mk2(new THREE.BoxGeometry(.22,.22,.32),0x1a1008);bL.position.set(-.17,.11,.05);g.add(bL);
  const bR=bL.clone();bR.position.set(.17,.11,.05);g.add(bR);
  // Legs
  const lL=mk2(new THREE.CylinderGeometry(.11,.10,.56,7),0x1a2010);lL.position.set(-.17,.49,0);g.add(lL);
  const lR=lL.clone();lR.position.set(.17,.49,0);g.add(lR);
  // Torso
  const torso=mk2(new THREE.CylinderGeometry(.28,.24,.60,8),teamColor);torso.position.set(0,.97,0);g.add(torso);
  // Vest detail
  const vest=mk2(new THREE.BoxGeometry(.44,.46,.28),dark);vest.position.set(0,.97,.07);g.add(vest);
  const pkt=mk2(new THREE.BoxGeometry(.12,.10,.08),dark);pkt.position.set(-.15,1.1,.21);g.add(pkt);
  // Arms
  const aL=mk2(new THREE.CylinderGeometry(.09,.08,.52,6),teamColor);aL.rotation.z=.5;aL.position.set(-.40,.88,0);g.add(aL);
  const aR=mk2(new THREE.CylinderGeometry(.09,.08,.52,6),teamColor);aR.rotation.z=-.5;aR.position.set(.40,.88,0);g.add(aR);
  // Head + helmet
  const head=mk2(new THREE.SphereGeometry(.24,10,8),skin);head.position.set(0,1.48,0);g.add(head);
  const helm=mk2(new THREE.SphereGeometry(.265,10,7,0,Math.PI*2,0,Math.PI*.55),teamColor);helm.position.set(0,1.51,0);g.add(helm);
  // Eyes
  const eL=mk2(new THREE.SphereGeometry(.055,6,6),0x111111);eL.position.set(-.10,1.50,.20);g.add(eL);
  const eR=eL.clone();eR.position.set(.10,1.50,.20);g.add(eR);
  // Eye glow
  const egL=mk2(new THREE.SphereGeometry(.03,5,5),teamColor);egL.position.copy(eL.position);g.add(egL);
  const egR=egL.clone();egR.position.copy(eR.position);g.add(egR);
  // Weapon holder
  const wh=new THREE.Group();wh.position.set(.38,.88,.26);g.add(wh);
  // HP ring
  const ring=new THREE.Mesh(new THREE.TorusGeometry(.52,.06,6,28),new THREE.MeshBasicMaterial({color:0x44ff44}));
  ring.rotation.x=-Math.PI/2;ring.position.y=.06;g.add(ring);
  // Armor plate indicator
  const armorPlate=mk2(new THREE.BoxGeometry(.48,.28,.10),0x4488ff);armorPlate.position.set(0,.97,.21);armorPlate.visible=false;g.add(armorPlate);
  // Name tag sprite (other players only)
  let nameSprite=null;
  if (!isMe) {
    const c=document.createElement('canvas');c.width=256;c.height=64;
    const cx2=c.getContext('2d');cx2.fillStyle='rgba(0,0,0,.65)';cx2.fillRect(2,2,252,60);
    cx2.fillStyle='#c8ff88';cx2.font='bold 26px Arial';cx2.textAlign='center';cx2.fillText('...',128,40);
    const tex=new THREE.CanvasTexture(c);
    nameSprite=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true}));
    nameSprite.scale.set(2.4,.6,1);nameSprite.position.set(0,2.3,0);g.add(nameSprite);
  }
  return { group:g, wh, ring, armorPlate, lL, lR, aR, nameSprite };
}

function updateNameTag(spr, name, kills) {
  if (!spr) return;
  const c=document.createElement('canvas');c.width=256;c.height=64;
  const cx2=c.getContext('2d');cx2.fillStyle='rgba(0,0,0,.7)';cx2.fillRect(2,2,252,60);
  cx2.fillStyle='#c8ff88';cx2.font='bold 24px Arial';cx2.textAlign='center';cx2.fillText(name.slice(0,16),128,30);
  cx2.fillStyle='#ffdd44';cx2.font='17px Arial';cx2.fillText('â˜  '+kills,128,52);
  spr.material.map.image=c;spr.material.map.needsUpdate=true;
}

function mkWepMesh(wkey) {
  const g=new THREE.Group();
  const mk2=(geo,col)=>new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));
  if (wkey==='knife'){const bl=mk2(new THREE.BoxGeometry(.06,.38,.06),0xcccccc);bl.position.y=.19;g.add(bl);const gd=mk2(new THREE.BoxGeometry(.2,.04,.06),0x888888);g.add(gd);const hd=mk2(new THREE.CylinderGeometry(.05,.05,.18,6),0x5a3010);hd.position.y=-.1;g.add(hd);}
  else if(wkey==='grenade'){const b=mk2(new THREE.SphereGeometry(.14,8,8),0x2a5a10);g.add(b);const t=mk2(new THREE.CylinderGeometry(.04,.04,.1,6),0x444444);t.position.y=.16;g.add(t);const p=new THREE.Mesh(new THREE.TorusGeometry(.06,.018,5,10),new THREE.MeshLambertMaterial({color:0xdddd00}));p.position.y=.2;g.add(p);}
  else if(wkey==='fists'){const f=mk2(new THREE.SphereGeometry(.13,8,8),0xe8c090);f.scale.set(1.2,.9,1.1);g.add(f);}
  else if(wkey==='rocket'){const body=mk2(new THREE.CylinderGeometry(.06,.06,.45,7),0xcc2200);body.rotation.x=Math.PI/2;body.position.z=.15;g.add(body);const nose=mk2(new THREE.ConeGeometry(.07,.14,7),0xff4400);nose.rotation.x=Math.PI/2;nose.position.z=.4;g.add(nose);const tube=mk2(new THREE.CylinderGeometry(.12,.12,.5,8),0x333333);g.add(tube);}
  else if(wkey==='flamethrower'){const tank=mk2(new THREE.CylinderGeometry(.1,.1,.4,7),0x334400);tank.rotation.z=Math.PI/2;tank.position.set(0,0,-.1);g.add(tank);const nozzle=mk2(new THREE.CylinderGeometry(.04,.04,.35,6),0x222222);nozzle.rotation.x=Math.PI/2;nozzle.position.z=.18;g.add(nozzle);}
  else if(wkey==='sniper'){const barrel=mk2(new THREE.CylinderGeometry(.03,.03,.75,6),0x2a2a2a);barrel.rotation.x=Math.PI/2;barrel.position.z=.3;g.add(barrel);const body=mk2(new THREE.BoxGeometry(.11,.13,.36),0x1c1c1c);g.add(body);const scope=mk2(new THREE.CylinderGeometry(.04,.04,.28,6),0x111111);scope.rotation.x=Math.PI/2;scope.position.set(0,.11,.06);g.add(scope);const stock=mk2(new THREE.BoxGeometry(.09,.11,.22),0x2a1a08);stock.position.set(0,0,-.28);g.add(stock);}
  else if(wkey==='minigun'){const drums=mk2(new THREE.CylinderGeometry(.16,.16,.32,6),0x333333);drums.rotation.x=Math.PI/2;drums.position.z=.05;g.add(drums);for(let i=0;i<6;i++){const b2=mk2(new THREE.CylinderGeometry(.03,.03,.45,5),0x222222);b2.rotation.x=Math.PI/2;b2.position.set(Math.cos(i*Math.PI/3)*.1,Math.sin(i*Math.PI/3)*.1,.2);g.add(b2);}const grip2=mk2(new THREE.BoxGeometry(.09,.2,.09),0x4a2e10);grip2.position.set(.02,-.17,-.06);g.add(grip2);}
  else if(wkey==='crossbow'){const body=mk2(new THREE.BoxGeometry(.10,.12,.38),0x3a2810);g.add(body);const limb=mk2(new THREE.BoxGeometry(.45,.05,.04),0x2a1a08);limb.position.z=.18;g.add(limb);const string=mk2(new THREE.BoxGeometry(.4,.012,.012),0xaaaaaa);string.position.z=.06;g.add(string);const bolt=mk2(new THREE.CylinderGeometry(.02,.02,.3,5),0x4a4030);bolt.rotation.x=Math.PI/2;bolt.position.z=.1;g.add(bolt);}
  else { // pistol, shotgun, rifle, smg
    const blen={pistol:.5,shotgun:.44,rifle:.68,smg:.38}[wkey]||.5;
    const barrel=mk2(new THREE.CylinderGeometry(.035,.035,blen,6),0x2a2a2a);barrel.rotation.x=Math.PI/2;barrel.position.z=blen/2-.02;g.add(barrel);
    const body=mk2(new THREE.BoxGeometry(.12,.14,{pistol:.28,shotgun:.32,rifle:.3,smg:.22}[wkey]||.28),0x1c1c1c);g.add(body);
    const grip=mk2(new THREE.BoxGeometry(.09,.2,.09),0x4a2e10);grip.position.set(.02,-.17,-.06);g.add(grip);
    if(wkey==='shotgun'){const pump=mk2(new THREE.BoxGeometry(.13,.10,.22),0x5a4010);pump.position.set(0,-.05,.14);g.add(pump);}
    if(wkey==='smg'){const mag=mk2(new THREE.BoxGeometry(.08,.24,.06),0x1a1a1a);mag.position.set(0,-.16,0);g.add(mag);}
  }
  return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let socket=null, myId=null;
let myX=0, myZ=0, myAngle=0;
let myHp=100, myLives=3, myKills=0, myDeaths=0;
let myInventory=[], myWepIdx=0;
let myMoney=200;
let myUpgrades={ armor:false, heavy_armor:false, speed:false, radar:false };
let myDead=false, myElim=false;
let gameActive=false;
let mapName='forest', matchTimer=600, playerCount=0;
let curLB=[];
let isLocked=false, isShopOpen=false, isLBOpen=false;
let lastAttack=0, pickupCD=0;
let myChar=null;

const otherPlayers = new Map(); // id -> {x,z,a,h,l,k,d,ar, char, tx,tz}
const srvBullets   = new Map(); // id -> {mesh,x,z}
const srvRockets   = new Map(); // id -> mesh
const flyGrenades  = [];
const particles    = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POINTER LOCK & MOUSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('pointerlockchange', () => {
  isLocked = document.pointerLockElement === renderer.domElement;
  document.getElementById('lock-ov').classList.toggle('off', isLocked || isShopOpen);
  if (!isLocked && gameActive && !myDead && !isShopOpen) {
    document.getElementById('lock-ov').classList.remove('off');
  }
});

document.addEventListener('mousemove', e => {
  if (!isLocked || !gameActive || myDead || isShopOpen) return;
  const sens = isADS ? 0.0012 : 0.003;
  camYaw   -= e.movementX * sens;
  camPitch  = Math.max(CAM_MIN_PITCH, Math.min(CAM_MAX_PITCH, camPitch - e.movementY * sens));
});

document.addEventListener('click', e => {
  if (!gameActive || isShopOpen || myDead || myElim) return;
  if (!isLocked) { renderer.domElement.requestPointerLock(); return; }
  doAttack();
});

document.addEventListener('mousedown', e => {
  if (e.button === 2) startADS();
});
document.addEventListener('mouseup', e => {
  if (e.button === 2) stopADS();
});

// Prevent right-click context
document.addEventListener('contextmenu', e => e.preventDefault());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const K = {};
document.addEventListener('keydown', e => {
  K[e.code] = true;
  if (!gameActive) return;
  if (e.code==='Tab')  { e.preventDefault(); openLB(true); }
  if (e.code==='KeyF') toggleShop();
  if (e.code==='KeyG') throwGrenade();
  if (e.code==='KeyQ') nextWeapon();
  if (e.code==='KeyE') { if (nearbyPickup) socket?.emit('pickup', { id: nearbyPickup.id }); }
  if (e.code==='KeyX') dropWeapon();
  if (e.code==='Escape') { stopADS(); closeShop(); document.exitPointerLock(); }
  for(let n=0;n<7;n++) if(e.code===`Digit${n+1}`) selectWeapon(n);
});
document.addEventListener('keyup', e => {
  K[e.code] = false;
  if (e.code==='Tab') openLB(false);
});
document.addEventListener('wheel', e => {
  if (!gameActive || isShopOpen) return;
  e.deltaY > 0 ? nextWeapon() : prevWeapon();
});

function nextWeapon() { if(myInventory.length>1) selectWeapon((myWepIdx+1)%myInventory.length); }
function prevWeapon() { if(myInventory.length>1) selectWeapon((myWepIdx-1+myInventory.length)%myInventory.length); }
function selectWeapon(idx) {
  if (idx >= myInventory.length || idx < 0) return;
  if (!myInventory[idx]) return;
  if (isADS) stopADS();
  myWepIdx = idx;
  if (myChar) setCharWep(myChar, myInventory[idx]?.key||'fists');
  socket?.emit('switchWeapon', { idx });
  updateWBar();
  const wkey = myInventory[idx]?.key;
  document.getElementById('ch').className = (wkey==='knife'||wkey==='fists') ? 'knife' : '';
}

function setCharWep(char, wkey) {
  if (char._wm) { char.wh.remove(char._wm); char._wm=null; }
  if (!wkey) return;
  char._wm = mkWepMesh(wkey);
  char.wh.add(char._wm);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATTACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doAttack() {
  if (!gameActive || myDead) return;
  const now = Date.now();
  const wep = myInventory[myWepIdx];
  if (!wep) return;
  const cd = WCD[wep.key] || 400;
  if (now - lastAttack < cd) return;
  lastAttack = now;

  const aim = getAimAngle();

  if (WTYPE[wep.key]==='gun' || WTYPE[wep.key]==='rocket') {
    if (wep.ammo<=0) { nextWeapon(); return; }
    wep.ammo--;
    socket?.emit('shoot', { wk:wep.key, a:aim });
    spawnMuzzle(myX+Math.sin(aim)*.9, 1.0, myZ+Math.cos(aim)*.9, WBCOLOR[wep.key]||0xffff88);
    if (wep.key==='flamethrower') spawnFlameParticles(myX, myZ, aim);
    updateWBar();
  } else if (WTYPE[wep.key]==='throw') {
    throwGrenade();
  } else {
    // melee
    socket?.emit('melee');
    swingAnim();
  }
}

function throwGrenade() {
  if (!gameActive||myDead) return;
  const gIdx = myInventory.findIndex(w=>w.key==='grenade');
  if (gIdx===-1||myInventory[gIdx].ammo<=0) return;
  myInventory[gIdx].ammo--;
  updateWBar();
  const aim=getAimAngle(), spd=.20;
  const vx=Math.sin(aim)*spd, vz=Math.cos(aim)*spd, vy=.18;
  spawnClientGrenade(myX+vx, 1.2, myZ+vz, vx, vy, vz);
  const px=myX+Math.sin(aim)*12, pz=myZ+Math.cos(aim)*12;
  socket?.emit('grenade',{x:px,z:pz,vx,vy,vz});
}

function spawnClientGrenade(ox,oy,oz,vx,vy,vz) {
  const m=new THREE.Mesh(new THREE.SphereGeometry(.15,7,7),new THREE.MeshLambertMaterial({color:0x336600}));
  m.position.set(ox,oy,oz); scene.add(m);
  flyGrenades.push({mesh:m,vx,vy,vz,bounced:false,timer:2600});
}

function swingAnim() {
  if (!myChar?.aR) return;
  let t=0;
  const iv=setInterval(()=>{t+=.15;myChar.aR.rotation.x=Math.sin(t*Math.PI*2)*.85;if(t>=1){clearInterval(iv);myChar.aR.rotation.x=0;}},16);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOVEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPEED_BASE = .10;
const WORLD_R    = 52;
let   speedMult  = 1.0;
let   lastSent   = 0;

function hitsColl(x, z, r=.45) {
  if (Math.hypot(x,z) > WORLD_R) return true;
  for (const c of colliders) if (Math.hypot(x-c.x,z-c.z) < r+c.r) return true;
  return false;
}

function processMove(dt) {
  if (!gameActive||myDead) return;
  // FPS movement: forward = where camera faces (projected to XZ)
  const fwdX = -Math.sin(camYaw), fwdZ = -Math.cos(camYaw);
  const rtX  =  Math.cos(camYaw), rtZ  = -Math.sin(camYaw);
  let mx=0,mz=0;
  if(K['KeyW']){mx+=fwdX;mz+=fwdZ;}
  if(K['KeyS']){mx-=fwdX;mz-=fwdZ;}
  if(K['KeyA']){mx-=rtX; mz-=rtZ;}
  if(K['KeyD']){mx+=rtX; mz+=rtZ;}
  if(mx!==0||mz!==0){
    const len=Math.hypot(mx,mz); mx/=len; mz/=len;
    const spd = SPEED_BASE * speedMult * (dt/16);
    const nx=myX+mx*spd, nz=myZ+mz*spd;
    if (!hitsColl(nx,myZ)) myX=nx;
    if (!hitsColl(myX,nz)) myZ=nz;
  }
  // Auto-fire for guns held
  if(K['MouseLeft']||K['Space']) doAttack();

  // FPS: own character model always hidden (we ARE the character)
  if (myChar) {
    myChar.group.visible = false;
    myChar.group.position.set(myX, 0, myZ);
  }

  // Send position + aim direction to server
  myAngle = camYaw + Math.PI; // facing = opposite of camYaw
  if (Date.now()-lastSent>45) {
    lastSent=Date.now();
    socket?.emit('move',{x:myX,z:myZ,a:myAngle});
  }
  checkPickups();
}

let nearbyPickup = null;

function checkPickups() {
  if (Date.now()-pickupCD<100) return; pickupCD=Date.now();
  nearbyPickup = null;
  for (const [id, pk] of pickupMeshes) {
    if (Math.hypot(myX-pk.x, myZ-pk.z) < 2.5) {
      nearbyPickup = { id, type: pk.type };
      break;
    }
  }
  const hint = document.getElementById('pickup-hint');
  if (nearbyPickup) {
    const name = WN[nearbyPickup.type] || nearbyPickup.type.toUpperCase();
    hint.textContent = '[E] PICK UP ' + name;
    hint.classList.add('show');
  } else {
    hint.classList.remove('show');
  }
}

function dropWeapon() {
  if (!gameActive || myDead) return;
  const wep = myInventory[myWepIdx];
  if (!wep || wep.key==='fists' || wep.key==='knife' || wep.key==='grenade') return;
  socket?.emit('dropWeapon', { idx: myWepIdx });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERPOLATE OTHER PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function interpOthers(dt) {
  for (const [,op] of otherPlayers) {
    if (op.d) { op.char.group.visible=false; continue; }
    op.char.group.visible = true;
    op.cx = op.cx===undefined ? op.tx : THREE.MathUtils.lerp(op.cx,op.tx,.18);
    op.cz = op.cz===undefined ? op.tz : THREE.MathUtils.lerp(op.cz,op.tz,.18);
    op.char.group.position.set(op.cx,0,op.cz);
    op.char.group.rotation.y = op.a;
    // Armor plate visibility
    if (op.char.armorPlate) op.char.armorPlate.visible = op.ar>0;
    // HP ring color
    const r=op.h/100;
    op.char.ring.material.color.setHex(r>.5?0x44ff44:r>.25?0xff9900:0xff2200);
    op.char.ring.visible=true;
    // Walk anim
    const moved=Math.hypot(op.tx-(op.px||op.tx),op.tz-(op.pz||op.tz))>.02;
    if (moved){const t=Date.now()*.008;if(op.char.lL)op.char.lL.rotation.x=Math.sin(t)*.5;if(op.char.lR)op.char.lR.rotation.x=Math.sin(t+Math.PI)*.5;}
    op.px=op.tx;op.pz=op.tz;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EFFECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_P=200;
function spawnMuzzle(x,y,z,col=0xffff88){
  const pl=new THREE.PointLight(col,4,5);pl.position.set(x,y,z);scene.add(pl);
  setTimeout(()=>scene.remove(pl),75);
}
function spawnBloodAt(x,z){
  for(let i=0;i<7&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.07+Math.random()*.12;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.04+Math.random()*.07,4,4),new THREE.MeshBasicMaterial({color:0x990000}));
    m.position.set(x,.8+Math.random()*.3,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.08+Math.random()*.1,vz:Math.sin(a)*spd,life:.9});
  }
}
function spawnFlameParticles(x,z,aim){
  for(let i=0;i<5&&particles.length<MAX_P;i++){
    const a=aim+(Math.random()-.5)*.5,spd=.12+Math.random()*.15;
    const col=Math.random()>.5?0xff4400:0xff8800;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.08+Math.random()*.1,5,5),new THREE.MeshBasicMaterial({color:col}));
    m.position.set(x+Math.sin(aim)*.5,1,z+Math.cos(aim)*.5);scene.add(m);
    particles.push({mesh:m,vx:Math.sin(a)*spd,vy:.02+Math.random()*.08,vz:Math.cos(a)*spd,life:.7,scale:true});
  }
}
function spawnExplosion(x,z,big){
  const pl=new THREE.PointLight(0xff6600,big?10:6,big?16:10);pl.position.set(x,1.5,z);scene.add(pl);
  setTimeout(()=>scene.remove(pl),big?500:350);
  for(let i=0;i<(big?18:10)&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.14+Math.random()*.25;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.06+Math.random()*.1,5,5),new THREE.MeshBasicMaterial({color:Math.random()>.5?0xff4400:0xffaa00}));
    m.position.set(x,1.2,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.2+Math.random()*.3,vz:Math.sin(a)*spd,life:.9});
  }
}
function tickParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vx*=.92;p.vz*=.92;p.vy-=.012;
    p.mesh.position.x+=p.vx;p.mesh.position.y+=p.vy;p.mesh.position.z+=p.vz;
    if(p.mesh.position.y<.02){p.mesh.position.y=.02;p.vy*=-.18;p.vx*=.6;p.vz*=.6;}
    p.life-=dt*.0014;
    if(p.scale&&p.mesh.scale)p.mesh.scale.setScalar(p.life);
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}
function tickGrenades(dt){
  for(let i=flyGrenades.length-1;i>=0;i--){
    const g=flyGrenades[i];
    g.timer-=dt;g.vy-=.009;
    g.mesh.position.x+=g.vx;g.mesh.position.y+=g.vy;g.mesh.position.z+=g.vz;
    g.mesh.rotation.x+=.1;
    if(g.mesh.position.y<=.15&&!g.bounced){g.bounced=true;g.vy=Math.abs(g.vy)*.3;g.vx*=.4;g.vz*=.4;}
    if(g.mesh.position.y<0)g.mesh.position.y=0;
    if(g.timer<=0){spawnExplosion(g.mesh.position.x,g.mesh.position.z,false);scene.remove(g.mesh);flyGrenades.splice(i,1);}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  document.getElementById('hp-fill').style.width=(myHp)+'%';
  document.getElementById('hp-fill').style.background=myHp>50?'#44ff44':myHp>25?'#ff9900':'#ff2200';
  // armor
  const armorPct=myUpgrades.heavy_armor?100:myUpgrades.armor?60:0;
  document.getElementById('armor-fill').style.width=armorPct+'%';
  document.getElementById('armor-bar-wrap').style.display=armorPct>0?'block':'none';
  // lives
  const lr=document.getElementById('livesrow');lr.innerHTML='';
  for(let i=0;i<3;i++){const p=document.createElement('div');p.className='lpip';p.style.background=i<myLives?'#ff5733':'#333';p.style.boxShadow=i<myLives?'0 0 5px #ff5733':'none';lr.appendChild(p);}
  // money
  document.getElementById('money').textContent='ğŸ’° $'+myMoney;
}

function updateWBar(){
  const bar=document.getElementById('wbar');bar.innerHTML='';
  for(let i=0;i<7;i++){
    const sl=document.createElement('div');sl.className='ws'+(i===myWepIdx?' active':'');
    const num=document.createElement('div');num.className='wnum';num.textContent=i+1;sl.appendChild(num);
    if(myInventory[i]){
      const w=myInventory[i];
      const wi=document.createElement('div');wi.className='wi';wi.textContent=WI[w.key]||'?';
      const wn=document.createElement('div');wn.className='wn';wn.textContent=WN[w.key]||w.key.toUpperCase();
      const wa=document.createElement('div');
      if(w.ammo===Infinity){wa.className='wa';wa.textContent='âˆ';}
      else if(w.key==='grenade'){wa.className='wa '+(w.ammo>0?'':'none');wa.textContent=w.ammo+'x';}
      else{const mx=WMAX[w.key]||1,r=w.ammo/mx;wa.className='wa '+(w.ammo===0?'none':r<.35?'low':'');wa.textContent=w.ammo+'/'+mx;}
      sl.appendChild(wi);sl.appendChild(wn);sl.appendChild(wa);sl.onclick=()=>selectWeapon(i);
    } else {sl.classList.add('empty');}
    bar.appendChild(sl);
  }
}

function updateTimer(){
  const m=~~(matchTimer/60),s=matchTimer%60;
  const el=document.getElementById('timer');
  el.textContent=m+':'+(s<10?'0':'')+s;
  el.style.color=matchTimer<60?'#ff5733':'#7fff00';
}

function addKill(killer,victim,col='#a0d060'){
  const el=document.createElement('div');el.className='km';el.style.borderColor=col;
  el.textContent=victim?killer+' âš” '+victim:killer;
  document.getElementById('kf').appendChild(el);
  setTimeout(()=>el.remove(),4000);
}

function flashHit(){
  const fl=document.getElementById('flash');fl.className='';void fl.offsetWidth;fl.className='pop';
  spawnBloodAt(myX,myZ);
}

let pToastTimer=null;
function showPickupToast(msg){
  const t=document.getElementById('ptost');t.textContent=msg;t.classList.add('show');
  clearTimeout(pToastTimer);pToastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

let moneyGainTimer=null;
function showMoneyGain(amount,reason){
  const el=document.getElementById('money-gain');
  el.textContent=`+$${amount} ${reason}`;el.style.opacity='1';
  clearTimeout(moneyGainTimer);
  moneyGainTimer=setTimeout(()=>el.style.opacity='0',2000);
}

let respawnIV=null;
function showDeadScreen(){
  document.getElementById('dead-screen').classList.remove('off');
  document.getElementById('lock-ov').classList.add('off');
  let cnt=3;document.getElementById('respawnNum').textContent=cnt;
  document.getElementById('livesLeft').textContent=myLives>0?myLives+' LIVES LEFT':'';
  clearInterval(respawnIV);
  respawnIV=setInterval(()=>{cnt--;document.getElementById('respawnNum').textContent=cnt;if(cnt<=0)clearInterval(respawnIV);},1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLB(open){
  isLBOpen=open;
  document.getElementById('lb-ov').classList.toggle('off',!open);
  if (open) renderLB();
}
function renderLB(){
  const rows=document.getElementById('lb-rows');rows.innerHTML='';
  if(!curLB.length){rows.innerHTML='<div style="padding:16px;text-align:center;color:#1a3a08">No data yet</div>';return;}
  for(let i=0;i<curLB.length;i++){
    const r=curLB[i];
    const row=document.createElement('div');row.className='lbr'+(i===0?' t1':'');
    row.innerHTML=`<div class="rank">${i+1}</div><div class="nm">${r.n}</div><div class="kl">${r.k}</div><div class="dt">${r.d}</div><div class="mo">$${r.m}</div>`;
    rows.appendChild(row);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleShop(){
  if(isShopOpen) closeShop(); else openShop();
}
function openShop(){
  if(!gameActive||myDead) return;
  isShopOpen=true;
  document.getElementById('shop-ov').classList.remove('off');
  document.getElementById('lock-ov').classList.add('off');
  document.exitPointerLock();
  renderShop();
}
function closeShop(){
  isShopOpen=false;
  document.getElementById('shop-ov').classList.add('off');
  document.getElementById('shop-feedback').textContent='';
  if (gameActive&&!myDead) document.getElementById('lock-ov').classList.remove('off');
}
function renderShop(){
  document.getElementById('shop-money-display').textContent='ğŸ’° $'+myMoney;
  const grid=document.getElementById('shop-items');grid.innerHTML='';
  for(const[key,item]of Object.entries(SHOP_DEFS)){
    const cell=document.createElement('div');
    const owned=myUpgrades[key];
    const locked=item.requires&&!myUpgrades[item.requires];
    const canAfford=myMoney>=item.price;
    cell.className='shop-item'+(owned?' owned':locked?' locked':'');
    cell.innerHTML=`
      <div class="sname">${item.icon} ${item.name}</div>
      <div class="sdesc">${item.desc}${item.requires?' (Requires '+item.requires.replace('_',' ').toUpperCase()+')':''}</div>
      <div class="sprice${!canAfford&&!owned?' noafford':''}">${item.type==='upgrade'?'$'+item.price:item.type==='consumable'?'$'+item.price:''}</div>
      ${owned?'<div class="owned-badge">âœ“ OWNED</div>':''}
    `;
    if(!owned&&!locked){
      cell.onclick=()=>{
        socket?.emit('buyItem',{itemKey:key});
      };
    }
    grid.appendChild(cell);
  }
}

document.getElementById('shop-close').addEventListener('click', closeShop);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mmC=document.getElementById('mm');
const mmX=mmC.getContext('2d');
const MM=130;
function drawMM(){
  mmX.clearRect(0,0,MM,MM);
  mmX.fillStyle='rgba(0,8,0,.88)';mmX.fillRect(0,0,MM,MM);
  const toMM=(x,z)=>({px:((x+62)/124)*MM,py:((z+62)/124)*MM});
  // pickups
  for(const[,p]of pickupMeshes){const{px,py}=toMM(p.x,p.z);mmX.fillStyle='#7fff00';mmX.beginPath();mmX.arc(px,py,2,0,Math.PI*2);mmX.fill();}
  // others
  for(const[,op]of otherPlayers){
    if(op.d)continue;
    const hasRadar=myUpgrades.radar||op.rd;
    if(!hasRadar){
      // Only show if close (within 20 units)
      if(Math.hypot((op.cx||op.tx)-myX,(op.cz||op.tz)-myZ)>20)continue;
    }
    const{px,py}=toMM(op.cx||op.tx,op.cz||op.tz);
    mmX.fillStyle='#ff5555';mmX.beginPath();mmX.arc(px,py,3,0,Math.PI*2);mmX.fill();
  }
  // self + facing arrow
  const{px,py}=toMM(myX,myZ);
  mmX.fillStyle='#ffffff';mmX.beginPath();mmX.arc(px,py,4.5,0,Math.PI*2);mmX.fill();
  // FPS: facing = camYaw+PI, arrow points where player is looking
  const faceDir = camYaw + Math.PI;
  const ax=px+Math.sin(faceDir)*9,ay=py+Math.cos(faceDir)*9;
  mmX.strokeStyle='#7fff00';mmX.lineWidth=2;mmX.beginPath();mmX.moveTo(px,py);mmX.lineTo(ax,ay);mmX.stroke();
  mmX.strokeStyle='#1a3a0a';mmX.lineWidth=2;mmX.strokeRect(1,1,MM-2,MM-2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER BULLET / ROCKET VISUALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncBulletVisuals(bArr){
  const seen=new Set();
  for(const b of bArr){
    seen.add(b.i);
    if(!srvBullets.has(b.i)){
      const m=new THREE.Mesh(new THREE.SphereGeometry(.08,5,5),new THREE.MeshBasicMaterial({color:b.c}));
      const pl=new THREE.PointLight(b.c,.9,3);m.add(pl);
      m.position.set(b.x,.9,b.z);scene.add(m);
      srvBullets.set(b.i,{mesh:m});
    } else { srvBullets.get(b.i).mesh.position.set(b.x,.9,b.z); }
  }
  for(const[id,sb]of srvBullets){if(!seen.has(id)){scene.remove(sb.mesh);srvBullets.delete(id);}}
}

function syncRocketVisuals(rArr){
  const seen=new Set();
  for(const r of rArr){
    seen.add(r.i);
    if(!srvRockets.has(r.i)){
      const g=new THREE.Group();
      const body=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,.4,6),new THREE.MeshLambertMaterial({color:0xcc2200}));
      body.rotation.x=Math.PI/2;g.add(body);
      const flame=new THREE.PointLight(0xff6600,2,4);g.add(flame);
      g.position.set(r.x,1,r.z);scene.add(g);srvRockets.set(r.i,g);
    } else {srvRockets.get(r.i).position.set(r.x,1,r.z);}
  }
  for(const[id,rm]of srvRockets){if(!seen.has(id)){scene.remove(rm);srvRockets.delete(id);}}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET.IO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connect(name){
  socket=io();
  socket.on('connect',()=>socket.emit('join',{name}));

  socket.on('joined',data=>{
    myId=data.playerId; mapName=data.mapName; matchTimer=data.timeLeft;
    myX=data.spawnX; myZ=data.spawnZ; myAngle=0;
    myInventory=data.inventory; myMoney=data.money; myWepIdx=0;
    myHp=100; myLives=3; myDead=false; myElim=false; myKills=0; myDeaths=0;
    myUpgrades={armor:false,heavy_armor:false,speed:false,radar:false};
    speedMult=1.0;

    buildMap(data.mapName);
    for(const pk of data.pickups) if(pk.active) mkPickupMesh(pk);

    if(myChar)scene.remove(myChar.group);
    myChar=buildChar(0x44aa22,true);
    myChar.group.position.set(myX,0,myZ);
    myChar.group.visible = false; // FPS: own model hidden
    scene.add(myChar.group);
    setCharWep(myChar,myInventory[0]?.key||'fists');

    // FPS camera snap
    camPitch = 0; camYaw = 0;
    snapCamera();

    document.getElementById('hud').classList.remove('off');
    document.getElementById('mapbadge').textContent=data.mapName.toUpperCase();
    document.getElementById('conn-screen').classList.add('off');
    document.getElementById('lock-ov').classList.remove('off');

    gameActive=true;
    updateHUD(); updateWBar(); updateTimer();
    addKill('Joined match on '+data.mapName.toUpperCase(),null,'#7fff00');
  });

  socket.on('S',data=>{
    matchTimer=data.T; playerCount=data.PC; curLB=data.LB||[];
    document.getElementById('pcbadge').textContent='ğŸ‘¤ '+playerCount;
    updateTimer();
    if(isLBOpen) renderLB();

    const seen=new Set();
    for(const pd of data.P){
      if(pd.i===myId){if(pd.k>myKills){myKills=pd.k;}continue;}
      seen.add(pd.i);
      if(!otherPlayers.has(pd.i)){
        const h=Math.abs(hashStr(pd.i))%360;
        const col=new THREE.Color().setHSL(h/360,.7,.5).getHex();
        const ch=buildChar(col,false);
        ch.group.position.set(pd.x,0,pd.z);scene.add(ch.group);
        otherPlayers.set(pd.i,{...pd,char:ch,tx:pd.x,tz:pd.z,cx:pd.x,cz:pd.z});
        updateNameTag(ch.nameSprite,pd.n,pd.k);
      } else {
        const op=otherPlayers.get(pd.i);
        op.tx=pd.x;op.tz=pd.z;op.a=pd.a;op.h=pd.h;op.l=pd.l;op.d=pd.d;op.k=pd.k;op.ar=pd.ar;
        if(op.lk!==pd.w){op.lk=pd.w;/* weapon switch */}
        updateNameTag(op.char.nameSprite,pd.n,pd.k);
      }
    }
    for(const[id,op]of otherPlayers){if(!seen.has(id)){scene.remove(op.char.group);otherPlayers.delete(id);}}

    syncBulletVisuals(data.B||[]);
    syncRocketVisuals(data.R||[]);
  });

  socket.on('hit',data=>{myHp=data.hp;flashHit();updateHUD();});
  socket.on('pHurt',data=>{const op=otherPlayers.get(data.id);if(op)op.h=data.hp;});

  socket.on('kill',data=>{
    addKill(data.kn,data.vn);
    if(data.ki===myId){myKills++;updateHUD();}
    // Show hit marker if I killed
    spawnBloodAt(0,0);
  });

  socket.on('earnMoney',data=>{
    myMoney=data.total;
    showMoneyGain(data.amount,data.reason);
    updateHUD();
    if(isShopOpen)renderShop();
  });

  socket.on('youDied',data=>{
    myDead=true;myLives=data.lives;myDeaths++;
    if(myChar)myChar.group.visible=false;
    showDeadScreen(); updateHUD();
  });

  socket.on('respawned',data=>{
    myX=data.x;myZ=data.z;myDead=false;myHp=100;
    myInventory=data.inventory||myInventory;
    myMoney=data.money||myMoney;
    if(myWepIdx>=myInventory.length) myWepIdx=0;
    if(myChar){myChar.group.position.set(myX,0,myZ);myChar.group.visible=false;}
    stopADS();
    snapCamera();
    document.getElementById('dead-screen').classList.add('off');
    document.getElementById('lock-ov').classList.remove('off');
    updateHUD(); updateWBar();
  });

  socket.on('eliminated',data=>{
    myElim=true;myDead=true;
    document.getElementById('dead-screen').classList.add('off');
    document.getElementById('elim-screen').classList.remove('off');
    document.getElementById('elimStats').innerHTML=`KILLS: ${data.kills||myKills}<br>DEATHS: ${data.deaths||myDeaths}<br><br><span style="color:#4a7a3a">You can still watch the match</span>`;
  });

  socket.on('shopResult',data=>{
    const fb=document.getElementById('shop-feedback');
    if(data.ok){
      myMoney=data.money;
      if(data.upgrade){myUpgrades[data.upgrade]=true;if(data.upgrade==='speed')speedMult=1.25;if(myChar&&myChar.armorPlate)myChar.armorPlate.visible=myUpgrades.armor||myUpgrades.heavy_armor;}
      if(data.inventory)myInventory=data.inventory;
      if(data.hp)myHp=data.hp;
      fb.style.color='#7fff00';fb.textContent='âœ“ '+SHOP_DEFS[data.itemKey]?.name+' purchased!';
      updateHUD();updateWBar();renderShop();
    } else {fb.style.color='#ff5533';fb.textContent='âœ— '+data.reason;}
  });

  socket.on('pickupOK',data=>{
    if (data.inventory) myInventory = data.inventory;
    // Clamp weapon index in case inventory shrunk (e.g. after drop)
    if (myWepIdx >= myInventory.length) myWepIdx = Math.max(0, myInventory.length-1);
    showPickupToast(data.msg||'PICKED UP');
    updateWBar();
    selectWeapon(myWepIdx);
  });
  socket.on('pickupGone',data=>removePickupMesh(data.id));
  socket.on('pickupBack',data=>{
    if(!pickupMeshes.has(data.id)&&data.x!==undefined) mkPickupMesh({id:data.id,type:data.type,x:data.x,z:data.z});
  });

  socket.on('grenadeFly',data=>{
    if(!data||!data.ox)return;
    spawnClientGrenade(data.ox,1.2,data.oz,data.vx,data.vy||.18,data.vz);
  });

  socket.on('explosion',data=>{spawnExplosion(data.x,data.z,data.big);});

  socket.on('matchEnd',data=>{
    gameActive=false;
    stopADS();
    document.getElementById('hud').classList.add('off');
    closeShop(); openLB(false);
    const sc=document.getElementById('end-screen');
    sc.classList.remove('off');
    document.getElementById('endWinner').textContent='ğŸ† '+(data.winner||'Match Over');
    const tb=document.querySelector('#endTable tbody');tb.innerHTML='';
    (data.results||[]).forEach((r,i)=>{
      const tr=document.createElement('tr');if(i===0)tr.className='gold';
      tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td style="color:#7fff00">${r.kills}</td><td style="color:#ff5733">${r.deaths}</td><td style="color:#ffd700">$${r.money}</td>`;
      tb.appendChild(tr);
    });
    document.exitPointerLock();
  });

  // â”€â”€ MAP VOTE â”€â”€
  let myVote = null;
  let voteChoices = [];
  let voteTimerIV = null;

  socket.on('voteStart', data => {
    voteChoices = data.choices;
    myVote = null;
    document.getElementById('vote-ov').classList.remove('off');
    renderVote(data.choices, {});
    // Countdown timer
    let secs = data.seconds;
    document.getElementById('vote-timer-fill').style.width = '100%';
    document.getElementById('vote-timer-txt').textContent = secs + 's';
    clearInterval(voteTimerIV);
    voteTimerIV = setInterval(() => {
      secs--;
      const pct = Math.max(0, (secs / data.seconds) * 100);
      document.getElementById('vote-timer-fill').style.width = pct + '%';
      document.getElementById('vote-timer-txt').textContent = Math.max(0, secs) + 's';
      if (secs <= 0) clearInterval(voteTimerIV);
    }, 1000);
  });

  socket.on('voteUpdate', data => {
    renderVote(voteChoices, data.votes);
  });

  socket.on('voteEnd', data => {
    clearInterval(voteTimerIV);
    document.getElementById('vote-title').textContent = 'ğŸ—º NEXT MAP: ' + data.winner.toUpperCase();
    document.getElementById('vote-sub').textContent = 'LOADING IN 3 SECONDS...';
    document.getElementById('vote-timer-fill').style.width = '0%';
    setTimeout(() => location.reload(), 3000);
  });

  function renderVote(choices, votes) {
    const total = Object.values(votes).reduce((a,b) => a+b, 0) || 1;
    const cards = document.getElementById('vote-cards');
    cards.innerHTML = '';
    const mapEmoji = { forest:'ğŸŒ²', city:'ğŸ™', warehouse:'ğŸ­', desert:'ğŸœ', arctic:'â„', rooftop:'ğŸ—' };
    choices.forEach(map => {
      const v = votes[map] || 0;
      const pct = Math.round((v / total) * 100);
      const card = document.createElement('div');
      card.className = 'vc' + (myVote === map ? ' voted' : '');
      card.innerHTML = `
        <div class="vc-name">${mapEmoji[map]||'ğŸ—º'} ${map.toUpperCase()}</div>
        <div class="vc-votes">${v}</div>
        <div class="vc-bar" style="width:${pct}%"></div>
        <div class="vc-pct">${pct}%</div>`;
      if (!myVote) {
        card.addEventListener('click', () => {
          myVote = map;
          socket?.emit('vote', { map });
        });
      }
      cards.appendChild(card);
    });
  }

  socket.on('pJoin',data=>addKill(data.name+' JOINED',null,'#7fff00'));
  socket.on('pLeave',data=>{
    addKill(data.name+' LEFT',null,'#ff5555');
    const op=otherPlayers.get(data.id);if(op){scene.remove(op.char.group);otherPlayers.delete(data.id);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTs=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(ts-lastTs,60);lastTs=ts;
  if(!gameActive){renderer.render(scene,camera);return;}
  processMove(dt);
  updateCamera(dt);
  interpOthers(dt);
  animPickups();
  tickGrenades(dt);
  tickParticles(dt);
  drawMM();
  renderer.render(scene,camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hashStr(s){let h=0;for(let i=0;i<s.length;i++)h=(Math.imul(31,h)+s.charCodeAt(i))|0;return h;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('joinBtn').addEventListener('click',()=>{
  const name=document.getElementById('nameInput').value.trim()||'Soldier';
  document.getElementById('join-screen').classList.add('off');
  document.getElementById('conn-screen').classList.remove('off');
  connect(name);
});
document.getElementById('nameInput').addEventListener('keydown',e=>{if(e.code==='Enter')document.getElementById('joinBtn').click();});
document.getElementById('replayBtn').addEventListener('click',()=>location.reload());
document.getElementById('lock-ov').addEventListener('click',()=>renderer.domElement.requestPointerLock());

// Start render loop
requestAnimationFrame(loop);
</script>
</body>
</html>
