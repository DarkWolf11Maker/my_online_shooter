<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forest Deathmatch Online</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
body{overflow:hidden;background:#000;font-family:'Share Tech Mono',monospace;}
canvas{display:block;position:fixed;top:0;left:0;z-index:0;}

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:200;background:radial-gradient(ellipse 80% 80% at 50% 40%,#0d2008 0%,#030903 100%);}
.screen.off{display:none!important;}
.logo{font-family:'Oswald',sans-serif;font-size:clamp(2rem,7vw,5rem);color:#7fff00;
  text-shadow:0 0 40px #4a9900,0 0 80px #1d4a00;letter-spacing:.15em;line-height:1;text-align:center;}
.logo-sub{color:#3a6020;font-size:.8rem;letter-spacing:.35em;margin-top:.4rem;}
input[type=text]{background:transparent;border:none;border-bottom:2px solid #7fff00;color:#fff;
  font-family:'Share Tech Mono',monospace;font-size:1.2rem;text-align:center;padding:.4rem 1rem;
  width:280px;outline:none;letter-spacing:.1em;margin-top:1.5rem;}
input[type=text]::placeholder{color:#2a4a18;}
.btn{margin-top:1.2rem;padding:.75rem 2.8rem;font-family:'Oswald',sans-serif;font-size:1.2rem;
  letter-spacing:.2em;background:transparent;border:2px solid #7fff00;color:#7fff00;cursor:pointer;
  text-transform:uppercase;position:relative;overflow:hidden;transition:color .2s;}
.btn::before{content:'';position:absolute;inset:0;background:#7fff00;transform:scaleX(0);transform-origin:left;transition:transform .2s;z-index:-1;}
.btn:hover{color:#000;}.btn:hover::before{transform:scaleX(1);}
.info-box{margin-top:1.2rem;border:1px solid #1a3a0a;padding:.8rem 1.5rem;color:#4a7030;font-size:.68rem;line-height:1.9;max-width:540px;text-align:center;}
.info-box strong{color:#6a9a40;font-family:'Oswald',sans-serif;font-size:.82rem;letter-spacing:.1em;}

/* â”€â”€ MODE SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mode-select{display:flex;gap:14px;margin-top:1.4rem;flex-wrap:wrap;justify-content:center;}
.mode-card{
  width:150px;border:2px solid #1a3a0a;background:rgba(0,8,0,.85);
  cursor:pointer;padding:1.1rem .8rem;text-align:center;position:relative;
  transition:all .18s;font-family:'Oswald',sans-serif;
}
.mode-card:hover{border-color:#7fff00;background:rgba(5,25,5,.9);transform:translateY(-3px);}
.mode-card.selected{border-color:#7fff00;background:rgba(0,40,0,.7);box-shadow:0 0 18px rgba(127,255,0,.35);}
.mode-card .mc-icon{font-size:1.8rem;margin-bottom:.4rem;}
.mode-card .mc-title{font-size:.95rem;color:#7fff00;letter-spacing:.12em;}
.mode-card .mc-desc{font-size:.58rem;color:#4a7030;letter-spacing:.08em;margin-top:.3rem;line-height:1.5;}
.mode-card .mc-badge{position:absolute;top:6px;right:6px;font-size:.52rem;color:#ffd700;letter-spacing:.1em;}

/* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hud{position:fixed;inset:0;pointer-events:none;z-index:50;}
#hud.off{display:none!important;}
#timer{position:absolute;top:12px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:1.2rem;letter-spacing:.2em;
  background:rgba(0,0,0,.65);border:1px solid rgba(127,255,0,.35);padding:5px 18px;color:#7fff00;}
#mapbadge{position:absolute;top:12px;left:16px;font-family:'Oswald',sans-serif;font-size:.85rem;
  letter-spacing:.2em;color:#4a7030;background:rgba(0,0,0,.6);border:1px solid #1a3a0a;padding:4px 10px;}
#modebadge{position:absolute;top:38px;left:16px;font-family:'Oswald',sans-serif;font-size:.72rem;
  letter-spacing:.18em;background:rgba(0,0,0,.6);border:1px solid #1a3a0a;padding:3px 9px;}
#pcbadge{position:absolute;top:12px;right:16px;font-size:.72rem;color:#4a7030;
  background:rgba(0,0,0,.6);border:1px solid #1a3a0a;padding:4px 10px;}
/* Team score */
#team-score{position:absolute;top:12px;left:50%;transform:translateX(-50%);display:none;
  font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.18em;
  background:rgba(0,0,0,.75);border:1px solid rgba(127,255,0,.25);padding:5px 18px;}
#ts-r{color:#ff4455;} #ts-sep{color:#666;} #ts-b{color:#44aaff;}
#money{position:absolute;top:52px;right:16px;font-family:'Oswald',sans-serif;font-size:.95rem;
  letter-spacing:.15em;color:#ffd700;text-shadow:0 0 10px #aa8800;
  background:rgba(0,0,0,.6);border:1px solid #554400;padding:4px 12px;}
#money-gain{position:absolute;top:90px;right:16px;font-family:'Oswald',sans-serif;font-size:.82rem;
  letter-spacing:.15em;color:#ffd700;pointer-events:none;opacity:0;transition:opacity .3s;}
/* HP */
#hpbar-wrap{position:absolute;bottom:126px;left:20px;display:flex;flex-direction:column;gap:4px;}
.bar-label{font-size:.63rem;color:#4a7030;letter-spacing:.15em;}
.bar-track{width:190px;height:9px;background:#111;border:1px solid #222;border-radius:2px;overflow:hidden;}
.bar-fill{height:100%;border-radius:2px;transition:width .12s,background .3s;}
#hp-fill{width:100%;background:#44ff44;}
#armor-fill{width:0%;background:#4488ff;}
#livesrow{display:flex;gap:5px;margin-top:2px;}
.lpip{width:13px;height:13px;border-radius:50%;}
/* Kill feed */
#kf{position:absolute;top:56px;left:16px;display:flex;flex-direction:column;gap:4px;max-width:300px;}
.km{font-family:'Oswald',sans-serif;font-size:.75rem;background:rgba(0,0,0,.8);
  border-left:3px solid #7fff00;padding:3px 9px 3px 7px;color:#a0d060;letter-spacing:.07em;
  animation:kmfade 4s forwards;}
@keyframes kmfade{0%{opacity:0;transform:translateX(-12px)}8%{opacity:1;transform:none}78%{opacity:1}100%{opacity:0}}
/* Weapon bar */
#wbar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:5px;align-items:flex-end;}
.ws{width:66px;height:66px;border:2px solid #1a3a0a;background:rgba(0,0,0,.75);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
  position:relative;transition:border-color .12s,transform .12s;cursor:pointer;}
.ws.active{border-color:#7fff00;background:rgba(0,22,0,.9);transform:translateY(-5px);box-shadow:0 0 14px rgba(127,255,0,.4);}
.ws.empty{opacity:.28;}
.ws .wi{font-size:1.45rem;line-height:1;}
.ws .wn{font-family:'Oswald',sans-serif;font-size:.5rem;letter-spacing:.08em;color:#7aaa50;}
.ws .wa{font-size:.6rem;color:#aaa;}
.ws .wa.low{color:#ff9900;animation:blink .45s step-end infinite;}
.ws .wa.none{color:#ff3300;}
.ws .wnum{position:absolute;top:3px;left:5px;font-size:.56rem;color:#3a5a20;}
@keyframes blink{50%{opacity:0;}}
/* Minimap */
#mm{position:absolute;bottom:20px;right:20px;width:130px;height:130px;
  border:2px solid #2a4a18;background:rgba(0,0,0,.85);border-radius:2px;}
/* Crosshair */
#ch{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:22px;height:22px;pointer-events:none;z-index:60;}
#ch::before,#ch::after{content:'';position:absolute;background:rgba(255,255,255,.88);}
#ch::before{width:2px;height:22px;left:10px;top:0;}
#ch::after{width:22px;height:2px;left:0;top:10px;}
#ch.knife::before{transform:rotate(45deg);background:#aaffaa;}
#ch.knife::after{transform:rotate(45deg);background:#aaffaa;}
#ch.airstrike::before,#ch.airstrike::after{background:rgba(255,215,0,.92);}
/* Hit marker */
#hitmark{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:18px;height:18px;pointer-events:none;z-index:65;opacity:0;}
#hitmark::before,#hitmark::after{content:'';position:absolute;left:0;top:0;right:0;bottom:0;margin:auto;
  width:18px;height:2px;background:rgba(255,80,80,.95);}
#hitmark::after{transform:rotate(90deg);}
@keyframes hmf{0%{opacity:0;transform:translate(-50%,-50%) scale(.7);}30%{opacity:1;transform:translate(-50%,-50%) scale(1);}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2);}}
.hm-pop{animation:hmf .22s ease-out forwards;}
.hm-hs::before,.hm-hs::after{background:rgba(255,200,0,.98)!important;}
/* Pickup hint/toast */
#ptost{position:fixed;bottom:106px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:1rem;letter-spacing:.18em;color:#ffd700;
  text-shadow:0 0 12px #aa8800;pointer-events:none;z-index:60;opacity:0;transition:opacity .3s;}
#ptost.show{opacity:1;}
#pickup-hint{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:.85rem;letter-spacing:.22em;color:#7fff00;
  text-shadow:0 0 10px #3a8800;pointer-events:none;z-index:60;opacity:0;transition:opacity .25s;
  background:rgba(0,0,0,.65);border:1px solid rgba(127,255,0,.3);padding:5px 14px;}
#pickup-hint.show{opacity:1;}
#drop-hint{position:fixed;bottom:115px;right:160px;font-family:'Oswald',sans-serif;
  font-size:.66rem;letter-spacing:.15em;color:#888;pointer-events:none;z-index:60;}
/* Streak banner */
#streak-banner{position:fixed;top:22%;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:1.3rem;letter-spacing:.3em;color:#ffd700;
  text-shadow:0 0 20px #aa6600;text-align:center;pointer-events:none;z-index:80;opacity:0;transition:opacity .3s;}
#streak-banner.show{opacity:1;}
/* Zone ring HUD */
#zone-bar{position:absolute;top:56px;left:50%;transform:translateX(-50%);display:none;
  font-family:'Oswald',sans-serif;font-size:.72rem;letter-spacing:.18em;color:#ff7733;
  background:rgba(0,0,0,.65);border:1px solid #aa4400;padding:3px 12px;}
/* Lock overlay */
#lock-ov{position:fixed;inset:0;z-index:150;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(0,0,0,.55);pointer-events:all;cursor:pointer;}
#lock-ov.off{display:none!important;}
#lock-ov p{font-family:'Oswald',sans-serif;font-size:1.9rem;letter-spacing:.3em;color:#7fff00;
  text-shadow:0 0 20px #4a9900;animation:lblink 1.5s ease-in-out infinite;}
#lock-ov small{color:#3a5a20;font-size:.8rem;letter-spacing:.2em;margin-top:.6rem;}
@keyframes lblink{0%,100%{opacity:.35;}50%{opacity:1.0;}}
/* Flash */
#flash{position:fixed;inset:0;pointer-events:none;z-index:180;opacity:0;background:rgba(255,30,0,.48);}
#flash.pop{animation:fpop .25s ease-out forwards;}
@keyframes fpop{0%{opacity:1;}100%{opacity:0;}}
/* Leaderboard */
#lb-ov{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:100;
  display:flex;align-items:center;justify-content:center;pointer-events:none;}
#lb-ov.off{display:none!important;}
#lb-box{min-width:460px;border:2px solid #7fff00;background:#020802;overflow:hidden;}
#lb-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.3em;color:#7fff00;
  background:#031503;padding:11px 18px;border-bottom:1px solid #1a4a0a;text-align:center;}
.lbr{display:flex;border-bottom:1px solid #0d1e08;}
.lbr:last-child{border:none;}
.lbr .rank{width:34px;font-family:'Oswald',sans-serif;font-size:.85rem;color:#3a5a20;text-align:center;padding:9px 0;}
.lbr .nm{flex:1;padding:9px 8px;color:#b0d880;font-size:.82rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lbr .kl{width:50px;text-align:center;padding:9px 0;font-family:'Oswald',sans-serif;color:#7fff00;font-size:.85rem;}
.lbr .dt{width:50px;text-align:center;padding:9px 0;color:#ff5733;font-size:.82rem;}
.lbr .mo{width:60px;text-align:center;padding:9px 0;color:#ffd700;font-size:.75rem;}
.lbr.me{background:rgba(127,255,0,.07);}
.lbr.t1 .nm,.lbr.t1 .rank{color:#ffd700;}
#lb-hint{font-size:.62rem;color:#1a3a08;text-align:center;padding:7px;letter-spacing:.15em;}

/* â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#shop-ov{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:110;
  display:flex;align-items:center;justify-content:center;pointer-events:all;}
#shop-ov.off{display:none!important;}
#shop-box{border:2px solid #aa8800;background:#080500;min-width:520px;max-width:620px;overflow:hidden;}
#shop-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.3em;color:#ffd700;
  background:#120900;padding:12px 20px;border-bottom:1px solid #443300;
  display:flex;justify-content:space-between;align-items:center;}
#shop-money-display{font-size:.9rem;color:#ffd700;}
#shop-close{background:none;border:none;color:#665500;font-size:1.4rem;cursor:pointer;padding:0 4px;}
#shop-close:hover{color:#ffd700;}
#shop-items{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#1a1000;}
.shop-item{background:#0a0600;padding:12px 16px;cursor:pointer;transition:background .15s;position:relative;}
.shop-item:hover{background:#140d00;}
.shop-item.owned{background:#050800;cursor:default;}
.shop-item.locked{background:#060600;cursor:not-allowed;opacity:.5;}
.sname{font-family:'Oswald',sans-serif;font-size:.88rem;color:#cc9900;letter-spacing:.1em;margin-bottom:3px;}
.sdesc{font-size:.65rem;color:#665500;line-height:1.5;margin-bottom:5px;}
.sprice{font-family:'Oswald',sans-serif;font-size:.85rem;color:#ffd700;}
.sprice.noafford{color:#ff4422;}
.owned-badge{position:absolute;top:8px;right:10px;font-size:.62rem;color:#4a8a20;letter-spacing:.1em;}
#shop-feedback{padding:10px 16px;font-size:.75rem;min-height:32px;border-top:1px solid #1a1000;background:#080500;}

/* â”€â”€ SCOPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scope-ov{position:fixed;inset:0;pointer-events:none;z-index:70;display:none;}
#scope-ov.show{display:block;}
#scope-lens{position:absolute;top:50%;left:50%;width:min(84vh,84vw);height:min(84vh,84vw);
  transform:translate(-50%,-50%);border-radius:50%;background:transparent;
  box-shadow:0 0 0 1000px rgba(0,0,0,.98);outline:3px solid #333;overflow:hidden;}
#scope-svg{position:absolute;inset:0;width:100%;height:100%;overflow:visible;}
#scope-label{position:absolute;bottom:8%;left:50%;transform:translateX(-50%);
  font-family:'Share Tech Mono',monospace;font-size:.7rem;letter-spacing:.25em;
  color:rgba(200,255,150,.45);pointer-events:none;white-space:nowrap;}
/* ADS */
#ads-bar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
  font-family:'Oswald',sans-serif;font-size:.65rem;letter-spacing:.25em;color:#7fff0055;
  pointer-events:none;z-index:60;display:none;}
#ads-bar.show{display:block;}

/* â”€â”€ MAP VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#vote-ov{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:400;
  display:flex;flex-direction:column;align-items:center;justify-content:center;}
#vote-ov.off{display:none!important;}
#vote-title{font-family:'Oswald',sans-serif;font-size:1.5rem;color:#7fff00;letter-spacing:.3em;margin-bottom:.3rem;text-align:center;}
#vote-sub{font-family:'Share Tech Mono',monospace;font-size:.78rem;color:#3a6020;letter-spacing:.2em;margin-bottom:1.6rem;}
#vote-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;}
.vc{padding:1.4rem 1.8rem;border:2px solid #1a3a0a;background:rgba(0,8,0,.85);
  cursor:pointer;font-family:'Oswald',sans-serif;transition:all .18s;min-width:140px;text-align:center;position:relative;}
.vc:hover{border-color:#7fff00;background:rgba(5,25,5,.9);transform:translateY(-3px);}
.vc.voted{border-color:#7fff00;background:rgba(0,50,0,.5);cursor:default;}
.vc .vc-name{font-size:1.05rem;color:#7fff00;letter-spacing:.15em;}
.vc .vc-votes{font-size:2.4rem;color:#fff;margin:.35rem 0;}
.vc .vc-bar{height:4px;background:#7fff00;margin-top:.4rem;transition:width .3s;min-width:4px;}
.vc .vc-pct{font-size:.63rem;color:#3a6020;margin-top:.3rem;}
#vote-timer-bar{width:300px;height:4px;background:#1a3a0a;margin-top:1.6rem;border-radius:2px;overflow:hidden;}
#vote-timer-fill{height:100%;background:#7fff00;transition:width 1s linear;}
#vote-timer-txt{font-family:'Oswald',sans-serif;font-size:.82rem;color:#4a7030;letter-spacing:.25em;margin-top:.4rem;}
#vote-mode-label{font-family:'Share Tech Mono',monospace;font-size:.7rem;color:#4a7030;margin-top:.8rem;letter-spacing:.15em;}

/* â”€â”€ END SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#endTable{margin-top:1.2rem;border-collapse:collapse;min-width:360px;}
#endTable th{font-family:'Oswald',sans-serif;font-size:.78rem;letter-spacing:.12em;color:#3a5a20;border-bottom:1px solid #1a3a0a;padding:6px 10px;}
#endTable td{padding:7px 10px;font-size:.82rem;color:#7aaa50;border-bottom:1px solid #0a1a05;}
#endTable tr.gold td{color:#ffd700;}
.dead-num{font-family:'Oswald',sans-serif;font-size:5rem;color:#ff5733;text-shadow:0 0 30px #cc2200;}
</style>
</head>
<body>

<!-- JOIN -->
<div id="join-screen" class="screen">
  <div class="logo">FOREST<br>DEATHMATCH</div>
  <div class="logo-sub">ONLINE Â· 3D Â· UP TO 50 PLAYERS Â· 6 MAPS</div>
  <input type="text" id="nameInput" maxlength="20" placeholder="ENTER YOUR NAME" autocomplete="off">

  <div style="font-family:'Oswald',sans-serif;font-size:.78rem;color:#3a6020;letter-spacing:.25em;margin-top:1.4rem;">SELECT GAME MODE</div>
  <div id="mode-select">
    <div class="mode-card selected" data-mode="ffa">
      <div class="mc-icon">âš”</div>
      <div class="mc-title">FREE FOR ALL</div>
      <div class="mc-desc">Every player for themselves.<br>Most kills wins.<br>6 min Â· 3 lives</div>
      <div class="mc-badge">CLASSIC</div>
    </div>
    <div class="mode-card" data-mode="tdm">
      <div class="mc-icon">ğŸ”´ğŸ”µ</div>
      <div class="mc-title">TEAM DEATHMATCH</div>
      <div class="mc-desc">Red vs Blue.<br>First to 30 kills wins.<br>8 min Â· 3 lives</div>
    </div>
    <div class="mode-card" data-mode="lms">
      <div class="mc-icon">ğŸ’€</div>
      <div class="mc-title">SURVIVAL</div>
      <div class="mc-desc">One life only.<br>Shrinking zone.<br>5 min Â· 1 life</div>
      <div class="mc-badge">HARDCORE</div>
    </div>
  </div>

  <button class="btn" id="joinBtn">JOIN MATCH</button>
  <div class="info-box">
    <strong>CONTROLS</strong><br>
    WASD / MOVE &nbsp;Â·&nbsp; MOUSE / AIM &nbsp;Â·&nbsp; LMB / SHOOT &amp; ATTACK &nbsp;Â·&nbsp; <strong style="color:#88ffcc">RMB / AIM DOWN SIGHTS</strong><br>
    G / GRENADE &nbsp;Â·&nbsp; Q or SCROLL / SWITCH WEAPON &nbsp;Â·&nbsp; 1â€“7 / SELECT SLOT<br>
    <strong style="color:#7fff00">E / PICK UP</strong> &nbsp;Â·&nbsp; <strong style="color:#ff9900">X / DROP GUN</strong> &nbsp;Â·&nbsp; TAB / LEADERBOARD &nbsp;Â·&nbsp; <strong style="color:#ffd700">F / SHOP</strong> &nbsp;Â·&nbsp; ESC / UNLOCK<br><br>
    <strong>KILLSTREAKS</strong> â€” 3 kills: Speed Â· 5 kills: Airstrike [Z] Â· 7 kills: Minigun<br>
    <strong>SUPPLY DROPS</strong> every 2 minutes Â· <strong>HEADSHOTS</strong> deal 2Ã— damage Â· Realistic bullet drop
  </div>
</div>

<!-- CONNECTING -->
<div id="conn-screen" class="screen off">
  <div class="logo" style="font-size:2rem;animation:lblink 1s ease-in-out infinite">CONNECTING...</div>
</div>

<!-- DEAD -->
<div id="dead-screen" class="screen off">
  <div style="font-family:'Oswald',sans-serif;font-size:1.1rem;color:#ff5733;letter-spacing:.3em">YOU DIED</div>
  <div class="dead-num" id="respawnNum">3</div>
  <div style="color:#3a5a20;font-size:.78rem;letter-spacing:.2em">RESPAWNING...</div>
  <div id="livesLeft" style="margin-top:.7rem;color:#6a7a5a;font-size:.72rem;letter-spacing:.2em"></div>
</div>

<!-- ELIMINATED -->
<div id="elim-screen" class="screen off">
  <div class="logo" style="color:#ff5733;font-size:3rem">ELIMINATED</div>
  <div style="color:#4a5a30;font-size:.82rem;letter-spacing:.2em;margin-top:1rem">NO LIVES REMAINING</div>
  <div id="elimStats" style="color:#7aaa50;margin-top:1.5rem;font-size:.88rem;text-align:center;line-height:2"></div>
</div>

<!-- MATCH END -->
<div id="end-screen" class="screen off">
  <div class="logo" style="font-size:2.5rem">MATCH OVER</div>
  <div id="endWinner" style="font-family:'Oswald',sans-serif;font-size:1.3rem;color:#ffd700;letter-spacing:.2em;margin-top:.6rem"></div>
  <table id="endTable"><thead><tr><th>#</th><th>PLAYER</th><th>KILLS</th><th>DEATHS</th><th>$</th></tr></thead><tbody></tbody></table>
  <button class="btn" id="replayBtn" style="margin-top:1.4rem">PLAY AGAIN</button>
</div>

<!-- HUD -->
<div id="hud" class="off">
  <div id="timer">6:00</div>
  <div id="team-score"><span id="ts-r">0</span><span id="ts-sep"> â€” </span><span id="ts-b">0</span></div>
  <div id="mapbadge">FOREST</div>
  <div id="modebadge" style="color:#7fff00">FFA</div>
  <div id="pcbadge">ğŸ‘¤ 1</div>
  <div id="zone-bar">âš  ZONE SHRINKING</div>
  <div id="money">ğŸ’° $200</div>
  <div id="money-gain"></div>
  <div id="kf"></div>
  <div id="hpbar-wrap">
    <div class="bar-label">HP</div>
    <div class="bar-track"><div class="bar-fill" id="hp-fill"></div></div>
    <div id="armor-bar-wrap" style="display:none">
      <div class="bar-label">ARMOR</div>
      <div class="bar-track"><div class="bar-fill" id="armor-fill"></div></div>
    </div>
    <div id="livesrow"></div>
  </div>
  <div id="wbar"></div>
  <canvas id="mm" width="130" height="130"></canvas>
</div>

<!-- CROSSHAIR + HIT MARKER -->
<div id="ch"></div>
<div id="hitmark"></div>

<!-- PICKUP HINTS -->
<div id="ptost"></div>
<div id="pickup-hint"></div>
<div id="drop-hint">X â€” DROP</div>

<!-- STREAK BANNER -->
<div id="streak-banner"></div>

<!-- LOCK OVERLAY -->
<div id="lock-ov">
  <p>CLICK TO PLAY</p>
  <small>MOVE MOUSE TO AIM Â· ESC TO UNLOCK</small>
</div>

<!-- FLASH -->
<div id="flash"></div>

<!-- LEADERBOARD -->
<div id="lb-ov" class="off">
  <div id="lb-box">
    <div id="lb-title">âš” LEADERBOARD</div>
    <div id="lb-rows"></div>
    <div id="lb-hint">TAB â€” CLOSE</div>
  </div>
</div>

<!-- SHOP -->
<div id="shop-ov" class="off">
  <div id="shop-box">
    <div id="shop-title">
      <span>ğŸª ARMORY</span>
      <span id="shop-money-display">ğŸ’° $200</span>
      <button id="shop-close">âœ•</button>
    </div>
    <div id="shop-items"></div>
    <div id="shop-feedback"></div>
  </div>
</div>

<!-- SCOPE -->
<div id="scope-ov">
  <div id="scope-lens">
    <svg id="scope-svg" viewBox="0 0 100 100">
      <!-- Center crosshair -->
      <line x1="50" y1="2"  x2="50" y2="42" stroke="rgba(180,255,120,.9)" stroke-width="0.7"/>
      <line x1="50" y1="58" x2="50" y2="98" stroke="rgba(180,255,120,.9)" stroke-width="0.7"/>
      <line x1="2"  y1="50" x2="42" y2="50" stroke="rgba(180,255,120,.9)" stroke-width="0.7"/>
      <line x1="58" y1="50" x2="98" y2="50" stroke="rgba(180,255,120,.9)" stroke-width="0.7"/>
      <!-- Center dot -->
      <circle cx="50" cy="50" r="1.2" fill="rgba(255,80,80,.95)"/>
      <!-- Mil-dot ring -->
      <circle cx="50" cy="50" r="20" fill="none" stroke="rgba(180,255,120,.35)" stroke-width="0.5"/>
      <!-- Stadia marks -->
      <line x1="26" y1="50" x2="28" y2="50" stroke="rgba(255,255,255,.55)" stroke-width="0.5"/>
      <line x1="72" y1="50" x2="74" y2="50" stroke="rgba(255,255,255,.55)" stroke-width="0.5"/>
      <line x1="36" y1="50" x2="38" y2="50" stroke="rgba(255,255,255,.4)"  stroke-width="0.4"/>
      <line x1="62" y1="50" x2="64" y2="50" stroke="rgba(255,255,255,.4)"  stroke-width="0.4"/>
    </svg>
    <div id="scope-label">âŠ• 10Ã— MAGNIFICATION</div>
  </div>
</div>

<div id="ads-bar">â— ADS</div>

<!-- MAP VOTE -->
<div id="vote-ov" class="off">
  <div id="vote-title">ğŸ—º VOTE FOR NEXT MAP</div>
  <div id="vote-sub">CLICK TO VOTE â€” MAJORITY WINS</div>
  <div id="vote-cards"></div>
  <div id="vote-timer-bar"><div id="vote-timer-fill" style="width:100%"></div></div>
  <div id="vote-timer-txt">20s</div>
  <div id="vote-mode-label"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENT WEAPON / SHOP DEFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WI   = { fists:'ğŸ‘Š',knife:'ğŸ”ª',grenade:'ğŸ’£',pistol:'ğŸ”«',shotgun:'ğŸ’¥',rifle:'ğŸ¯',smg:'âš¡',sniper:'ğŸ¯',minigun:'ğŸ”¥',crossbow:'ğŸ¹',rocket:'ğŸš€',flamethrower:'ğŸ”¥',ammo:'ğŸ’',supply:'ğŸ“¦' };
const WN   = { fists:'FISTS',knife:'KNIFE',grenade:'GRENADE',pistol:'PISTOL',shotgun:'SHOTGUN',rifle:'RIFLE',smg:'SMG',sniper:'SNIPER',minigun:'MINIGUN',crossbow:'CROSSBOW',rocket:'ROCKET',flamethrower:'FLAMER',ammo:'AMMO',supply:'SUPPLY DROP' };
const WCD  = { fists:450,knife:350,grenade:800,pistol:360,shotgun:750,rifle:110,smg:80,sniper:950,minigun:48,crossbow:1000,rocket:2200,flamethrower:60 };
const WMAX = { pistol:13,shotgun:8,rifle:30,smg:30,sniper:5,minigun:120,crossbow:8,rocket:4,flamethrower:80 };
const WTYPE= { fists:'melee',knife:'melee',grenade:'throw',pistol:'gun',shotgun:'gun',rifle:'gun',smg:'gun',sniper:'gun',minigun:'gun',crossbow:'gun',rocket:'rocket',flamethrower:'gun' };
const WBCOLOR={ pistol:0xffee00,shotgun:0xff8800,rifle:0x00ffcc,smg:0xcc88ff,sniper:0xffffff,minigun:0xffaa00,crossbow:0x88ff44,rocket:0xff4400,flamethrower:0xff6600 };
// Realistic recoil patterns per weapon
const WRECOIL={ pistol:0.045,shotgun:0.075,rifle:0.030,smg:0.020,sniper:0.095,minigun:0.013,crossbow:0.055,rocket:0.082,flamethrower:0.011 };

const SHOP_DEFS={
  armor:       { price:200,name:'Armor Vest',  icon:'ğŸ›¡',desc:'Absorbs 25% damage',          type:'upgrade' },
  heavy_armor: { price:400,name:'Heavy Armor', icon:'âš”',desc:'Absorbs 50% damage',          type:'upgrade',requires:'armor' },
  speed:       { price:150,name:'Speed Boost', icon:'ğŸ’¨',desc:'Move 25% faster permanently', type:'upgrade' },
  health_kit:  { price:80, name:'Health Kit',  icon:'â¤',desc:'Instantly restore 50 HP',     type:'consumable' },
  gren_pack:   { price:100,name:'Grenade Pack',icon:'ğŸ’£',desc:'Receive +2 grenades',         type:'consumable' },
  ammo_crate:  { price:120,name:'Ammo Crate',  icon:'ğŸ’',desc:'Refill all gun ammo fully',   type:'consumable' },
  stimpack:    { price:180,name:'Stimpack',    icon:'ğŸ’Š',desc:'Regenerate HP for 12 seconds',type:'consumable' },
  radar:       { price:250,name:'Radar',       icon:'ğŸ“¡',desc:'Always see enemies on minimap',type:'upgrade' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedMode = sessionStorage.getItem('fdm_mode') || 'ffa';

document.querySelectorAll('.mode-card').forEach(card => {
  if (card.dataset.mode === selectedMode) card.classList.add('selected');
  else card.classList.remove('selected');
  card.addEventListener('click', () => {
    selectedMode = card.dataset.mode;
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene    = new THREE.Scene();
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.insertBefore(renderer.domElement, document.body.firstChild);
const camera = new THREE.PerspectiveCamera(72, window.innerWidth/window.innerHeight, 0.1, 500);

let ambLight=null, sunLight=null, baseAmbI=0.7, baseSunI=1.0, baseFog=0.02;
let weather=null, weatherType='none', weatherData=null;
let audioCtx=null, masterGain=null;

window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let camYaw=0, camPitch=0;
const CAM_MIN_PITCH=-1.4, CAM_MAX_PITCH=1.4, FPS_EYE_H=1.52;
let isADS=false;
const FOV_NORMAL=72, FOV_ADS=42, FOV_SNIPER=14;
const camPos=new THREE.Vector3(), camTarget=new THREE.Vector3();
// Recoil
let recoilPitch=0, recoilYaw=0;
let walkPhase=0, moveSpeed=0;
let screenShake=0;

function updateCamera(dt) {
  if (!gameActive) return;
  const bobAmp=Math.min(0.07,moveSpeed*0.007);
  const ty=FPS_EYE_H+(bobAmp>0?Math.sin(walkPhase)*bobAmp:0);
  camPos.lerp(new THREE.Vector3(myX,ty,myZ), Math.min(1,dt*0.4));
  // Apply recoil smoothly
  recoilPitch*=0.82; recoilYaw*=0.82;
  const shake=screenShake>0?(Math.random()-.5)*screenShake*0.003:0;
  screenShake=Math.max(0,screenShake-dt*0.08);
  camera.position.copy(camPos);
  const totalPitch=camPitch+recoilPitch+shake;
  const totalYaw=camYaw+recoilYaw;
  const dx=-Math.sin(totalYaw)*Math.cos(totalPitch);
  const dy=-Math.sin(totalPitch);
  const dz=-Math.cos(totalYaw)*Math.cos(totalPitch);
  camera.lookAt(camPos.x+dx*500,camPos.y+dy*500,camPos.z+dz*500);
}

function getAimAngle(){
  const dir=new THREE.Vector3();camera.getWorldDirection(dir);
  return Math.atan2(dir.x,dir.z);
}
function getAimPitch(){
  const dir=new THREE.Vector3();camera.getWorldDirection(dir);
  return -Math.asin(Math.max(-1,Math.min(1,dir.y)));
}
function getAimPointOnGround(){
  const dir=new THREE.Vector3();camera.getWorldDirection(dir);
  const o=camera.position;
  let t=60;
  if (Math.abs(dir.y)>0.001){const tt=(0-o.y)/dir.y;if(tt>0)t=Math.min(120,tt);}
  return {x:o.x+dir.x*t,z:o.z+dir.z*t};
}

function snapCamera(){
  camPos.set(myX,FPS_EYE_H,myZ);
  camera.position.copy(camPos);
  const dx=-Math.sin(camYaw),dz=-Math.cos(camYaw);
  camera.lookAt(myX+dx*100,FPS_EYE_H,myZ+dz*100);
}

function startADS(){
  if (!isLocked||!gameActive||myDead||isShopOpen) return;
  isADS=true;
  const wkey=myInventory[myWepIdx]?.key;
  if (wkey==='sniper'){camera.fov=FOV_SNIPER;document.getElementById('scope-ov').classList.add('show');document.getElementById('ch').style.display='none';}
  else {camera.fov=FOV_ADS;document.getElementById('ads-bar').classList.add('show');}
  camera.updateProjectionMatrix();
}
function stopADS(){
  isADS=false;camera.fov=FOV_NORMAL;camera.updateProjectionMatrix();
  document.getElementById('scope-ov').classList.remove('show');
  document.getElementById('ads-bar').classList.remove('show');
  document.getElementById('ch').style.display='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupLighting(mapName){
  scene.children.filter(c=>c.isLight).forEach(c=>scene.remove(c));
  const configs={
    forest:   {bg:0x0d1a07,fog:['exp2',0x0d1a07,0.020],amb:[0x223322,0.8],sun:[0x99cc66,1.3,25,50,15]},
    city:     {bg:0x0a1018,fog:['lin',0x111820,30,120], amb:[0x223344,0.6],sun:[0xaabbcc,0.9,-20,50,10]},
    warehouse:{bg:0x080d08,fog:['lin',0x0a0f0a,20,80],  amb:[0x334433,0.5],sun:[0xbbddaa,0.7,0,50,0]},
    desert:   {bg:0x2a1e0a,fog:['exp2',0x3a2810,0.014], amb:[0x554422,0.9],sun:[0xffcc88,1.5,30,60,20]},
    arctic:   {bg:0x1a2435,fog:['exp2',0x8899bb,0.022], amb:[0x4466aa,0.7],sun:[0xaaccff,1.0,-10,45,5]},
    rooftop:  {bg:0x080c12,fog:['lin',0x101520,40,160], amb:[0x222233,0.6],sun:[0x8899bb,0.8,20,50,-10]},
  };
  const cfg=configs[mapName]||configs.forest;
  scene.background=new THREE.Color(cfg.bg);
  if (cfg.fog[0]==='exp2'){scene.fog=new THREE.FogExp2(cfg.fog[1],cfg.fog[2]);baseFog=cfg.fog[2];}
  else {scene.fog=new THREE.Fog(cfg.fog[1],cfg.fog[2],cfg.fog[3]);baseFog=0.02;}
  ambLight=new THREE.AmbientLight(cfg.amb[0],cfg.amb[1]);baseAmbI=cfg.amb[1];scene.add(ambLight);
  sunLight=new THREE.DirectionalLight(cfg.sun[0],cfg.sun[1]);baseSunI=cfg.sun[1];
  sunLight.position.set(cfg.sun[2],cfg.sun[3],cfg.sun[4]);
  sunLight.castShadow=true;sunLight.shadow.mapSize.width=sunLight.shadow.mapSize.height=2048;
  sunLight.shadow.camera.left=sunLight.shadow.camera.bottom=-75;
  sunLight.shadow.camera.right=sunLight.shadow.camera.top=75;
  sunLight.shadow.camera.near=0.1;sunLight.shadow.camera.far=250;scene.add(sunLight);
  if (mapName==='city'||mapName==='rooftop'){
    const lamps=[[-20,-20],[-20,20],[20,-20],[20,20],[0,0],[-10,0],[10,0],[0,-10],[0,10],[-30,0],[30,0],[0,-30],[0,30]];
    for(const[lx,lz]of lamps){const pl=new THREE.PointLight(mapName==='city'?0xff8844:0x4488ff,1.4,20);pl.position.set(lx,7,lz);scene.add(pl);}
  }
  if (mapName==='warehouse'){const lps=[[-15,-15],[15,-15],[-15,15],[15,15],[0,0],[-15,0],[15,0],[0,-15],[0,15]];for(const[lx,lz]of lps){const pl=new THREE.PointLight(0xddffcc,1.1,22);pl.position.set(lx,9,lz);scene.add(pl);}}
  if (mapName==='arctic') scene.add(new THREE.HemisphereLight(0x8899bb,0xaabbdd,0.4));
}

function applyTimeOfDay(){
  if (!ambLight||!sunLight) return;
  const total=(gameMode==='ffa')?360:(gameMode==='lms')?300:480;
  const prog=total>0?(1-(matchTimer/total)):0;
  const night=Math.max(0,Math.min(1,prog));
  sunLight.intensity=baseSunI*(1-0.65*night);
  ambLight.intensity=baseAmbI*(1-0.35*night);
  if (scene.fog&&scene.fog.isFogExp2){
    const wFog=weatherType==='rain'?0.010:weatherType==='snow'?0.005:0;
    scene.fog.density=(baseFog*(1+night*1.4))+wFog;
  }
}

function setupWeather(mapName){
  if (weather){scene.remove(weather);weather=null;weatherData=null;}
  if (mapName==='arctic') weatherType='snow';
  else if (mapName==='forest'||mapName==='city'||mapName==='rooftop') weatherType='rain';
  else weatherType='none';
  if (weatherType==='none') return;
  const count=weatherType==='rain'?1100:850;
  const pos=new Float32Array(count*3),vel=new Float32Array(count);
  for(let i=0;i<count;i++){
    const rx=(Math.random()-.5)*90,rz=(Math.random()-.5)*90,ry=Math.random()*26+2;
    pos[i*3]=myX+rx;pos[i*3+1]=ry;pos[i*3+2]=myZ+rz;
    vel[i]=weatherType==='rain'?6+Math.random()*6:1.2+Math.random()*1.4;
  }
  const geo=new THREE.BufferGeometry();
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const mat=new THREE.PointsMaterial({color:weatherType==='rain'?0x88aaff:0xffffff,size:weatherType==='rain'?0.06:0.10,transparent:true,opacity:weatherType==='rain'?0.55:0.75,depthWrite:false});
  weather=new THREE.Points(geo,mat);weather.frustumCulled=false;scene.add(weather);
  weatherData={pos,vel,count};
}
function tickWeather(dt){
  if (!weather||!weatherData) return;
  const p=weather.geometry.attributes.position.array,count=weatherData.count,fall=dt*0.001;
  for(let i=0;i<count;i++){
    p[i*3+1]-=weatherData.vel[i]*fall;
    if (p[i*3+1]<0){p[i*3]=myX+(Math.random()-.5)*90;p[i*3+1]=24+Math.random()*6;p[i*3+2]=myZ+(Math.random()-.5)*90;}
  }
  weather.geometry.attributes.position.needsUpdate=true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP BUILDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mapObjects=[], colliders=[];
function addMap(m){if(m.castShadow!==undefined)m.castShadow=true;if(m.receiveShadow!==undefined)m.receiveShadow=true;scene.add(m);mapObjects.push(m);return m;}
function clearMap(){mapObjects.forEach(o=>scene.remove(o));mapObjects.length=0;colliders.length=0;for(const[,p]of pickupMeshes)scene.remove(p.group);pickupMeshes.clear();for(const[,b]of barrelMeshes)scene.remove(b);barrelMeshes.clear();}
function mkM(geo,col,cast=true,recv=false){const m=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));m.castShadow=cast;m.receiveShadow=recv;return m;}

function buildForest(){
  setupLighting('forest');
  addMap(mkM(new THREE.PlaneGeometry(140,140),0x1a2a12,false,true)).rotation.x=-Math.PI/2;
  for(let i=0;i<60;i++){const x=(Math.random()-.5)*110,z=(Math.random()-.5)*110;if(Math.hypot(x,z)>58||(Math.abs(x)<10&&Math.abs(z)<10))continue;const s=0.6+Math.random()*1.2;const t=new THREE.Group();const trunk=mkM(new THREE.CylinderGeometry(.16*s,.24*s,1.6*s,7),0x3d2200);trunk.position.y=.8*s;t.add(trunk);for(let c=0;c<3;c++){const cone=mkM(new THREE.ConeGeometry((1.4-c*.3)*s,(1.8-c*.3)*s,8),c%2===0?0x1a4208:0x255a10);cone.position.y=(1.6+c*.9+((1.8-c*.3)*s)*.5)*s;t.add(cone);}t.position.set(x,0,z);addMap(t);colliders.push({x,z,r:.4*s});}
  const rocks=[[-22,-6],[22,6],[-10,18],[10,-18],[-30,18],[30,-18]];
  for(const[rx,rz]of rocks){const r=mkM(new THREE.DodecahedronGeometry(1.5+Math.random(),0),0x4a4540);r.position.set(rx,0.5,rz);r.rotation.y=Math.random()*Math.PI;addMap(r);colliders.push({x:rx,z:rz,r:1.6});}
}

function buildCity(){
  setupLighting('city');
  addMap(mkM(new THREE.PlaneGeometry(140,140),0x1e2022,false,true)).rotation.x=-Math.PI/2;
  const bldgs=[[-20,-20,12,8,18],[-20,20,12,8,22],[20,-20,10,6,14],[20,20,14,6,20],[0,0,10,10,28],[-32,0,8,6,16],[32,0,8,6,12],[0,-32,14,8,10],[0,32,12,8,15],[-20,0,6,6,12],[20,0,6,6,16],[-10,-10,5,5,8],[10,10,5,5,10]];
  for(const[bx,bz,bw,bd,bh]of bldgs){const b=mkM(new THREE.BoxGeometry(bw,bh,bd),0x2a3038);b.position.set(bx,bh/2,bz);addMap(b);colliders.push({x:bx,z:bz,r:Math.max(bw,bd)*.65});
    const roof=mkM(new THREE.BoxGeometry(bw+.4,.3,bd+.4),0x343c44);roof.position.set(bx,bh+.15,bz);addMap(roof);}
  const cars=[[-8,-20],[8,-20],[-8,20],[8,20],[-20,-8],[-20,8],[20,-8],[20,8]];
  for(const[cx,cz]of cars){const car=new THREE.Group();const body=mkM(new THREE.BoxGeometry(2.2,1.0,4.2),0x334455);body.position.y=.5;car.add(body);const roof=mkM(new THREE.BoxGeometry(1.8,.7,2.4),0x2a3848);roof.position.y=1.35;car.add(roof);car.position.set(cx,0,cz);car.rotation.y=Math.random()>.5?0:Math.PI/2;addMap(car);colliders.push({x:cx,z:cz,r:1.8});}
}

function buildWarehouse(){
  setupLighting('warehouse');
  addMap(mkM(new THREE.PlaneGeometry(100,100),0x1a1e1a,false,true)).rotation.x=-Math.PI/2;
  const wc=0x2a302a,wh=14;
  [[0,wh/2,-46,96,wh,1],[0,wh/2,46,96,wh,1],[-46,wh/2,0,1,wh,92],[46,wh/2,0,1,wh,92]].forEach(([x,y,z,w,h,d])=>{const wall=mkM(new THREE.BoxGeometry(w,h,d),wc);wall.position.set(x,y,z);addMap(wall);});
  for(let x=-30;x<=30;x+=15)for(let z=-30;z<=30;z+=15){if(Math.abs(x)<8&&Math.abs(z)<8)continue;const p=mkM(new THREE.CylinderGeometry(.4,.4,wh,8),0x3a4038);p.position.set(x,wh/2,z);addMap(p);colliders.push({x,z,r:.65});}
  const cpos=[[-20,-20],[-20,20],[20,-20],[20,20],[-10,-10],[10,10],[-10,10],[10,-10],[-25,0],[25,0],[0,-25],[0,25]];
  for(const[cx,cz]of cpos){const sh=1+Math.floor(Math.random()*3);for(let h=0;h<sh;h++){const w2=2.2+Math.random()*.6;const cr=mkM(new THREE.BoxGeometry(w2,2,w2),0x4a4030);cr.position.set(cx+(Math.random()-.5)*.5,1+h*2,cz+(Math.random()-.5)*.5);addMap(cr);}colliders.push({x:cx,z:cz,r:1.7});}
}

function buildDesert(){
  setupLighting('desert');
  const gnd=mkM(new THREE.PlaneGeometry(130,130,40,40),0x8b6b3a,false,true);gnd.rotation.x=-Math.PI/2;
  const dp=gnd.geometry.attributes.position;for(let i=0;i<dp.count;i++)dp.setY(i,(Math.random()-.5)*.2);
  gnd.geometry.computeVertexNormals();addMap(gnd);
  const colPos=[[-20,-15],[20,-15],[-20,15],[20,15],[0,-20],[0,20],[-30,0],[30,0],[-12,0],[12,0],[0,0]];
  for(const[cx,cz]of colPos){const h=3+Math.random()*5;const col=mkM(new THREE.CylinderGeometry(.6,.75,h,7),0x8a7050);col.position.set(cx,h/2,cz);addMap(col);colliders.push({x:cx,z:cz,r:.8});}
  for(let i=0;i<12;i++){const x=(Math.random()-.5)*80,z=(Math.random()-.5)*80;const s=3+Math.random()*4;const dune=mkM(new THREE.SphereGeometry(s,8,5),0xaa8850);dune.scale.y=.25;dune.position.set(x,s*.12,z);addMap(dune);}
  for(let i=0;i<8;i++){const a=i/8*Math.PI*2,r=8+Math.random()*4;const g=new THREE.Group();const trunk=mkM(new THREE.CylinderGeometry(.18,.28,4,6),0x5a3a10);trunk.position.y=2;g.add(trunk);const crown=mkM(new THREE.SphereGeometry(1.8,8,6),0x2a6010);crown.scale.y=.5;crown.position.y=4.5;g.add(crown);g.position.set(Math.cos(a)*r,0,Math.sin(a)*r);addMap(g);}
}

function buildArctic(){
  setupLighting('arctic');
  const gnd=mkM(new THREE.PlaneGeometry(130,130,40,40),0xdde8f0,false,true);gnd.rotation.x=-Math.PI/2;
  const ap=gnd.geometry.attributes.position;for(let i=0;i<ap.count;i++)ap.setY(i,(Math.random()-.5)*.08);
  gnd.geometry.computeVertexNormals();addMap(gnd);
  for(let i=0;i<25;i++){const x=(Math.random()-.5)*90,z=(Math.random()-.5)*90;const s=2+Math.random()*4;const drift=mkM(new THREE.SphereGeometry(s,8,5),0xe8f0f8);drift.scale.y=.22;drift.position.set(x,s*.11,z);addMap(drift);}
  const bpos=[[-20,-15],[20,-15],[-20,15],[20,15],[0,-20],[0,20],[-30,0],[30,0],[0,0],[-14,14],[14,-14]];
  for(const[bx,bz]of bpos){const h=1.5+Math.random()*2.5;const b=mkM(new THREE.DodecahedronGeometry(h*.7,0),0x8aaccc);b.position.set(bx,h*.35,bz);b.rotation.y=Math.random()*Math.PI*2;addMap(b);colliders.push({x:bx,z:bz,r:h*.55});}
  for(let i=0;i<40;i++){const x=(Math.random()-.5)*90,z=(Math.random()-.5)*90;if(Math.hypot(x,z)>52||(Math.abs(x)<10&&Math.abs(z)<10))continue;const s=.7+Math.random()*1.0;const g=new THREE.Group();const t=mkM(new THREE.CylinderGeometry(.12*s,.2*s,1.4*s,6),0x3d2200);t.position.y=.7*s;g.add(t);for(let c=0;c<3;c++){const cone=mkM(new THREE.ConeGeometry((1.0-c*.15)*s,(1.5-c*.3)*s,6),c%2===0?0x1a4208:0xdde8f0);cone.position.y=(1.4+c*.8+((1.5-c*.3)*s)*.5)*s;g.add(cone);}g.position.set(x,0,z);addMap(g);colliders.push({x,z,r:.5*s});}
}

function buildRooftop(){
  setupLighting('rooftop');
  addMap(mkM(new THREE.PlaneGeometry(60,60),0x22262e,false,true)).rotation.x=-Math.PI/2;
  const platforms=[[-25,2,12,12],[25,2,12,12],[0,2,10,20]];
  for(const[px,py,pw,pd]of platforms){const pl=mkM(new THREE.BoxGeometry(pw,.6,pd),0x222630);pl.position.set(px,py-.3,0);addMap(pl);}
  const acPos=[[-15,-15],[15,-15],[15,15],[-15,15],[0,-20],[0,20],[-8,0],[8,0]];
  for(const[ax,az]of acPos){const ac=new THREE.Group();const body=mkM(new THREE.BoxGeometry(2.5,1.4,1.8),0x334040);body.position.y=.7;ac.add(body);ac.position.set(ax,0,az);addMap(ac);colliders.push({x:ax,z:az,r:1.4});}
  const vPos=[[-22,0],[22,0],[0,-22],[0,22],[-12,-8],[12,8]];
  for(const[vx,vz]of vPos){const v=mkM(new THREE.BoxGeometry(1.5,.8,4),0x2a3038);v.position.set(vx,.4,vz);addMap(v);colliders.push({x:vx,z:vz,r:1.5});}
  const wtPos=[[-28,-28],[28,28],[-28,28]];
  for(const[wx,wz]of wtPos){const tank=mkM(new THREE.CylinderGeometry(1.8,1.8,3,12),0x3a3028);tank.position.set(wx,3.5,wz);addMap(tank);colliders.push({x:wx,z:wz,r:2.2});}
  for(let i=0;i<30;i++){const bx=(Math.random()-.5)*200+((Math.random()>.5)?80:-80),bz=(Math.random()-.5)*200,bh=10+Math.random()*50,bw=5+Math.random()*10;const bldg=mkM(new THREE.BoxGeometry(bw,bh,bw),new THREE.Color().setHSL(.6,.15,.06+Math.random()*.04).getHex());bldg.position.set(bx,bh/2,bz);addMap(bldg);}
}

function buildMap(name){
  clearMap();
  if(name==='forest')buildForest();else if(name==='city')buildCity();else if(name==='warehouse')buildWarehouse();else if(name==='desert')buildDesert();else if(name==='arctic')buildArctic();else if(name==='rooftop')buildRooftop();
  setupWeather(name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKUPS / BARRELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PC_COLORS={pistol:0xffee00,shotgun:0xff8800,rifle:0x00ffcc,smg:0xcc88ff,sniper:0xffffff,minigun:0xff8800,crossbow:0x88ff44,rocket:0xff4400,flamethrower:0xff6600,ammo:0x00ff88,supply:0x00ffaa};
const pickupMeshes=new Map(), barrelMeshes=new Map();

function mkBarrelMesh(br){
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.CylinderGeometry(.45,.45,1.1,12),new THREE.MeshLambertMaterial({color:0xaa1111,emissive:0x220000}));
  body.position.y=.55;g.add(body);
  const band=new THREE.Mesh(new THREE.TorusGeometry(.45,.05,6,24),new THREE.MeshLambertMaterial({color:0x222222}));
  band.rotation.x=Math.PI/2;band.position.y=.78;g.add(band);
  const b2=band.clone();b2.position.y=.32;g.add(b2);
  const glow=new THREE.PointLight(0xff2200,.8,4);glow.position.y=.55;g.add(glow);
  g.position.set(br.x,0,br.z);scene.add(g);barrelMeshes.set(br.id,g);
}
function removeBarrelMesh(id){const m=barrelMeshes.get(id);if(m){scene.remove(m);barrelMeshes.delete(id);}}
function syncBarrels(arr){
  const seen=new Set();
  for(const br of arr){seen.add(br.id);if(!barrelMeshes.has(br.id))mkBarrelMesh(br);}
  for(const[id]of barrelMeshes)if(!seen.has(id))removeBarrelMesh(id);
}

function mkPickupMesh(pk){
  const g=new THREE.Group();
  const col=PC_COLORS[pk.type]||0xffffff;
  const plat=new THREE.Mesh(new THREE.CylinderGeometry(.62,.62,.12,12),new THREE.MeshLambertMaterial({color:col,emissive:new THREE.Color(col).multiplyScalar(.3)}));g.add(plat);
  const geoBody=pk.type==='ammo'?new THREE.BoxGeometry(.5,.4,.7):pk.type==='supply'?new THREE.BoxGeometry(.65,.55,.65):new THREE.BoxGeometry(.14,.12,.42);
  const body=new THREE.Mesh(geoBody,new THREE.MeshLambertMaterial({color:(pk.type==='ammo'||pk.type==='supply')?0x223322:0x222222}));body.position.y=.44;g.add(body);
  const ring=new THREE.Mesh(new THREE.TorusGeometry(.72,.05,5,22),new THREE.MeshBasicMaterial({color:col}));ring.rotation.x=-Math.PI/2;g.add(ring);
  const pl=new THREE.PointLight(col,1.2,5);g.add(pl);
  g.position.set(pk.x,.7,pk.z);scene.add(g);pickupMeshes.set(pk.id,{group:g,x:pk.x,z:pk.z,type:pk.type});
}
function removePickupMesh(id){const p=pickupMeshes.get(id);if(p){scene.remove(p.group);pickupMeshes.delete(id);}}
function animPickups(){const t=Date.now()*.001;for(const[,p]of pickupMeshes){p.group.position.y=.6+Math.sin(t*1.4+p.x)*.18;p.group.rotation.y=t*.85;}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER + WEAPON MESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChar(teamColor,isMe){
  const g=new THREE.Group();
  const mk2=(geo,col)=>{const m=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));m.castShadow=true;return m;};
  const dark=new THREE.Color(teamColor).multiplyScalar(.5).getHex();
  const skin=0xe8c090;
  const bL=mk2(new THREE.BoxGeometry(.22,.22,.32),0x1a1008);bL.position.set(-.17,.11,.05);g.add(bL);
  const bR=bL.clone();bR.position.set(.17,.11,.05);g.add(bR);
  const lL=mk2(new THREE.CylinderGeometry(.11,.10,.56,7),0x1a2010);lL.position.set(-.17,.49,0);g.add(lL);
  const lR=lL.clone();lR.position.set(.17,.49,0);g.add(lR);
  const torso=mk2(new THREE.CylinderGeometry(.28,.24,.60,8),teamColor);torso.position.set(0,.97,0);g.add(torso);
  const vest=mk2(new THREE.BoxGeometry(.44,.46,.28),dark);vest.position.set(0,.97,.07);g.add(vest);
  const aL=mk2(new THREE.CylinderGeometry(.09,.08,.52,6),teamColor);aL.rotation.z=.5;aL.position.set(-.40,.88,0);g.add(aL);
  const aR=mk2(new THREE.CylinderGeometry(.09,.08,.52,6),teamColor);aR.rotation.z=-.5;aR.position.set(.40,.88,0);g.add(aR);
  const head=mk2(new THREE.SphereGeometry(.24,10,8),skin);head.position.set(0,1.48,0);g.add(head);
  const helm=mk2(new THREE.SphereGeometry(.265,10,7,0,Math.PI*2,0,Math.PI*.55),teamColor);helm.position.set(0,1.51,0);g.add(helm);
  const eL=mk2(new THREE.SphereGeometry(.055,6,6),0x111111);eL.position.set(-.10,1.50,.20);g.add(eL);
  const eR=eL.clone();eR.position.set(.10,1.50,.20);g.add(eR);
  const wh=new THREE.Group();wh.position.set(.38,.88,.26);g.add(wh);
  const ring=new THREE.Mesh(new THREE.TorusGeometry(.52,.06,6,28),new THREE.MeshBasicMaterial({color:0x44ff44}));ring.rotation.x=-Math.PI/2;ring.position.y=.06;g.add(ring);
  const armorPlate=mk2(new THREE.BoxGeometry(.48,.28,.10),0x4488ff);armorPlate.position.set(0,.97,.21);armorPlate.visible=false;g.add(armorPlate);
  let nameSprite=null;
  if (!isMe){
    const c=document.createElement('canvas');c.width=256;c.height=64;
    const cx2=c.getContext('2d');cx2.fillStyle='rgba(0,0,0,.65)';cx2.fillRect(2,2,252,60);
    cx2.fillStyle='#c8ff88';cx2.font='bold 26px Arial';cx2.textAlign='center';cx2.fillText('...',128,40);
    const tex=new THREE.CanvasTexture(c);
    nameSprite=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true}));
    nameSprite.scale.set(2.4,.6,1);nameSprite.position.set(0,2.3,0);g.add(nameSprite);
  }
  return {group:g,wh,ring,armorPlate,lL,lR,aR,nameSprite};
}
function updateNameTag(spr,name,kills,team){
  if (!spr) return;
  const c=document.createElement('canvas');c.width=256;c.height=64;
  const cx2=c.getContext('2d');
  cx2.fillStyle=team==='r'?'rgba(60,0,0,.75)':team==='b'?'rgba(0,10,60,.75)':'rgba(0,0,0,.7)';
  cx2.fillRect(2,2,252,60);
  cx2.fillStyle=team==='r'?'#ff6677':team==='b'?'#55bbff':'#c8ff88';
  cx2.font='bold 24px Arial';cx2.textAlign='center';cx2.fillText(name.slice(0,16),128,30);
  cx2.fillStyle='#ffdd44';cx2.font='17px Arial';cx2.fillText('â˜  '+kills,128,52);
  spr.material.map.image=c;spr.material.map.needsUpdate=true;
}

function mkWepMesh(wkey){
  const g=new THREE.Group();
  const mk2=(geo,col)=>new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));
  if(wkey==='knife'){const bl=mk2(new THREE.BoxGeometry(.06,.38,.06),0xcccccc);bl.position.y=.19;g.add(bl);const gd=mk2(new THREE.BoxGeometry(.2,.04,.06),0x888888);g.add(gd);const hd=mk2(new THREE.CylinderGeometry(.05,.05,.18,6),0x5a3010);hd.position.y=-.1;g.add(hd);}
  else if(wkey==='grenade'){const b=mk2(new THREE.SphereGeometry(.14,8,8),0x2a5a10);g.add(b);const t=mk2(new THREE.CylinderGeometry(.04,.04,.1,6),0x444444);t.position.y=.16;g.add(t);}
  else if(wkey==='fists'){const f=mk2(new THREE.SphereGeometry(.13,8,8),0xe8c090);f.scale.set(1.2,.9,1.1);g.add(f);}
  else if(wkey==='rocket'){const body=mk2(new THREE.CylinderGeometry(.06,.06,.45,7),0xcc2200);body.rotation.x=Math.PI/2;body.position.z=.15;g.add(body);const nose=mk2(new THREE.ConeGeometry(.07,.14,7),0xff4400);nose.rotation.x=Math.PI/2;nose.position.z=.4;g.add(nose);const tube=mk2(new THREE.CylinderGeometry(.12,.12,.5,8),0x333333);g.add(tube);}
  else if(wkey==='flamethrower'){const tank=mk2(new THREE.CylinderGeometry(.1,.1,.4,7),0x334400);tank.rotation.z=Math.PI/2;tank.position.set(0,0,-.1);g.add(tank);const nozzle=mk2(new THREE.CylinderGeometry(.04,.04,.35,6),0x222222);nozzle.rotation.x=Math.PI/2;nozzle.position.z=.18;g.add(nozzle);}
  else if(wkey==='sniper'){const barrel=mk2(new THREE.CylinderGeometry(.025,.025,.85,6),0x1a1a1a);barrel.rotation.x=Math.PI/2;barrel.position.z=.35;g.add(barrel);const body=mk2(new THREE.BoxGeometry(.10,.13,.36),0x1c1c1c);g.add(body);const scope=mk2(new THREE.CylinderGeometry(.04,.04,.28,6),0x111111);scope.rotation.x=Math.PI/2;scope.position.set(0,.11,.06);g.add(scope);const stock=mk2(new THREE.BoxGeometry(.08,.10,.22),0x2a1a08);stock.position.set(0,0,-.28);g.add(stock);}
  else if(wkey==='minigun'){const drums=mk2(new THREE.CylinderGeometry(.16,.16,.32,6),0x333333);drums.rotation.x=Math.PI/2;drums.position.z=.05;g.add(drums);for(let i=0;i<6;i++){const b2=mk2(new THREE.CylinderGeometry(.025,.025,.48,5),0x222222);b2.rotation.x=Math.PI/2;b2.position.set(Math.cos(i*Math.PI/3)*.1,Math.sin(i*Math.PI/3)*.1,.2);g.add(b2);}const grip2=mk2(new THREE.BoxGeometry(.09,.2,.09),0x4a2e10);grip2.position.set(.02,-.17,-.06);g.add(grip2);}
  else if(wkey==='crossbow'){const body=mk2(new THREE.BoxGeometry(.10,.12,.38),0x3a2810);g.add(body);const limb=mk2(new THREE.BoxGeometry(.45,.05,.04),0x2a1a08);limb.position.z=.18;g.add(limb);const bolt=mk2(new THREE.CylinderGeometry(.018,.018,.32,5),0x4a4030);bolt.rotation.x=Math.PI/2;bolt.position.z=.12;g.add(bolt);}
  else{
    const blen={pistol:.48,shotgun:.42,rifle:.72,smg:.36}[wkey]||.5;
    const barrel=mk2(new THREE.CylinderGeometry(.028,.028,blen,6),0x1a1a1a);barrel.rotation.x=Math.PI/2;barrel.position.z=blen/2-.02;g.add(barrel);
    const body=mk2(new THREE.BoxGeometry(.12,.14,{pistol:.26,shotgun:.30,rifle:.28,smg:.20}[wkey]||.28),0x1c1c1c);g.add(body);
    const grip=mk2(new THREE.BoxGeometry(.09,.2,.09),0x4a2e10);grip.position.set(.02,-.17,-.06);g.add(grip);
    if(wkey==='shotgun'){const pump=mk2(new THREE.BoxGeometry(.13,.10,.22),0x5a4010);pump.position.set(0,-.05,.14);g.add(pump);}
    if(wkey==='smg'){const mag=mk2(new THREE.BoxGeometry(.08,.24,.06),0x1a1a1a);mag.position.set(0,-.16,0);g.add(mag);}
    if(wkey==='rifle'){const mag=mk2(new THREE.BoxGeometry(.07,.20,.06),0x1a1a1a);mag.position.set(0,-.16,.02);g.add(mag);const carry=mk2(new THREE.BoxGeometry(.06,.06,.32),0x282828);carry.position.set(0,.12,.04);g.add(carry);}
  }
  return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let socket=null,myId=null;
let myX=0,myZ=0,myAngle=0;
let myHp=100,myLives=3,myKills=0,myDeaths=0;
let myInventory=[],myWepIdx=0;
let myMoney=200;
let myUpgrades={armor:false,heavy_armor:false,speed:false,radar:false};
let myDead=false,myElim=false;
let gameActive=false;
let mapName='forest',matchTimer=360,playerCount=0;
let gameMode='ffa',myTeam=null,zoneR=52;
let streakSpeedEnd=0,airstrikeReady=false,airstrikeMode=false;
let curLB=[],teamScore={r:0,b:0};
let isLocked=false,isShopOpen=false,isLBOpen=false;
let lastAttack=0,pickupCD=0;
let myChar=null;
const otherPlayers=new Map(),srvBullets=new Map(),srvRockets=new Map();
const flyGrenades=[],particles=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('pointerlockchange',()=>{
  isLocked=document.pointerLockElement===renderer.domElement;
  document.getElementById('lock-ov').classList.toggle('off',isLocked||isShopOpen);
  if (!isLocked&&gameActive&&!myDead&&!isShopOpen) document.getElementById('lock-ov').classList.remove('off');
});
document.addEventListener('mousemove',e=>{
  if (!isLocked||!gameActive||myDead||isShopOpen) return;
  const sens=isADS?0.0010:0.0028;
  camYaw-=e.movementX*sens;
  camPitch=Math.max(CAM_MIN_PITCH,Math.min(CAM_MAX_PITCH,camPitch-e.movementY*sens));
});
document.addEventListener('click',e=>{
  if (!gameActive||isShopOpen||myDead||myElim) return;
  if (!isLocked){renderer.domElement.requestPointerLock();return;}
  if (airstrikeMode){callAirstrike();return;}
  doAttack();
});
document.addEventListener('mousedown',e=>{if(e.button===2)startADS();});
document.addEventListener('mouseup',e=>{if(e.button===2)stopADS();});
document.addEventListener('contextmenu',e=>e.preventDefault());

const K={};
document.addEventListener('keydown',e=>{
  K[e.code]=true;
  if (!gameActive) return;
  if (e.code==='Tab'){e.preventDefault();openLB(true);}
  if (e.code==='KeyF') toggleShop();
  if (e.code==='KeyG') throwGrenade();
  if (e.code==='KeyQ') nextWeapon();
  if (e.code==='KeyZ'&&airstrikeReady){airstrikeMode=!airstrikeMode;document.getElementById('ch').classList.toggle('airstrike',airstrikeMode);}
  if (e.code==='KeyE'){
    if (nearbyPickup&&myInventory.length<7) socket?.emit('pickup',{id:nearbyPickup.id});
  }
  if (e.code==='KeyX') dropWeapon();
  if (e.code==='Escape'){stopADS();closeShop();document.exitPointerLock();}
  for(let n=0;n<7;n++) if(e.code===`Digit${n+1}`) selectWeapon(n);
});
document.addEventListener('keyup',e=>{K[e.code]=false;if(e.code==='Tab')openLB(false);});
document.addEventListener('wheel',e=>{if(!gameActive||isShopOpen)return;e.deltaY>0?nextWeapon():prevWeapon();});

function callAirstrike(){
  if (!airstrikeReady||!socket||!gameActive||myDead||isShopOpen) return;
  const pt=getAimPointOnGround();
  socket.emit('airstrike',{x:pt.x,z:pt.z});
  airstrikeReady=false;airstrikeMode=false;
  document.getElementById('ch').classList.remove('airstrike');
  showPickupToast('âœˆ AIRSTRIKE CALLED');
}

function nextWeapon(){if(myInventory.length>1)selectWeapon((myWepIdx+1)%myInventory.length);}
function prevWeapon(){if(myInventory.length>1)selectWeapon((myWepIdx-1+myInventory.length)%myInventory.length);}
function selectWeapon(idx){
  if(idx>=myInventory.length||idx<0||!myInventory[idx])return;
  if(isADS)stopADS();
  myWepIdx=idx;
  if(myChar)setCharWep(myChar,myInventory[idx]?.key||'fists');
  socket?.emit('switchWeapon',{idx});
  updateWBar();
  const wkey=myInventory[idx]?.key;
  const ch=document.getElementById('ch');
  ch.className=(wkey==='knife'||wkey==='fists')?'knife':airstrikeMode?'airstrike':'';
}
function setCharWep(char,wkey){
  if(char._wm){char.wh.remove(char._wm);char._wm=null;}
  if(!wkey)return;
  char._wm=mkWepMesh(wkey);char.wh.add(char._wm);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATTACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doAttack(){
  if(!gameActive||myDead)return;
  const now=Date.now(),wep=myInventory[myWepIdx];
  if(!wep)return;
  const cd=WCD[wep.key]||400;
  if(now-lastAttack<cd)return;
  lastAttack=now;
  const aim=getAimAngle();
  if(WTYPE[wep.key]==='gun'||WTYPE[wep.key]==='rocket'){
    if(wep.ammo<=0){nextWeapon();return;}
    wep.ammo--;
    // Realistic recoil per weapon
    const kick=WRECOIL[wep.key]||0.03;
    recoilPitch=Math.max(recoilPitch-kick,-0.12);
    recoilYaw+=(Math.random()-.5)*kick*0.4;
    const pitch=getAimPitch();
    socket?.emit('shoot',{wk:wep.key,a:aim,p:pitch});
    spawnMuzzle(myX+Math.sin(aim)*.9,1.0,myZ+Math.cos(aim)*.9,WBCOLOR[wep.key]||0xffff88,wep.key);
    if(wep.key==='flamethrower')spawnFlameParticles(myX,myZ,aim);
    updateWBar();
  }else if(WTYPE[wep.key]==='throw'){
    throwGrenade();
  }else{
    socket?.emit('melee');
    swingAnim();
  }
}

function throwGrenade(){
  if(!gameActive||myDead)return;
  const gIdx=myInventory.findIndex(w=>w.key==='grenade');
  if(gIdx===-1||myInventory[gIdx].ammo<=0)return;
  myInventory[gIdx].ammo--;updateWBar();
  const aim=getAimAngle(),spd=.20;
  const vx=Math.sin(aim)*spd,vz=Math.cos(aim)*spd,vy=.18;
  spawnClientGrenade(myX+vx,1.2,myZ+vz,vx,vy,vz);
  const px=myX+Math.sin(aim)*12,pz=myZ+Math.cos(aim)*12;
  socket?.emit('grenade',{x:px,z:pz,vx,vy,vz});
}
function spawnClientGrenade(ox,oy,oz,vx,vy,vz){
  const m=new THREE.Mesh(new THREE.SphereGeometry(.15,7,7),new THREE.MeshLambertMaterial({color:0x336600}));
  m.position.set(ox,oy,oz);scene.add(m);
  flyGrenades.push({mesh:m,vx,vy,vz,bounced:false,timer:2600});
}
function swingAnim(){
  if(!myChar?.aR)return;
  let t=0;const iv=setInterval(()=>{t+=.15;myChar.aR.rotation.x=Math.sin(t*Math.PI*2)*.85;if(t>=1){clearInterval(iv);myChar.aR.rotation.x=0;}},16);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOVEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPEED_BASE=.10,WORLD_R=52;
let speedMult=1.0,lastSent=0,lastStepSnd=0;
let velX=0,velZ=0;
const ACCEL=0.0009,FRICTION=0.88;

function hitsColl(x,z,r=.45){
  if(Math.hypot(x,z)>WORLD_R)return true;
  for(const c of colliders)if(Math.hypot(x-c.x,z-c.z)<r+c.r)return true;
  return false;
}
function processMove(dt){
  if(!gameActive||myDead)return;
  const now=Date.now();
  const streakBoost=now<streakSpeedEnd?1.35:1.0;
  const fwdX=-Math.sin(camYaw),fwdZ=-Math.cos(camYaw);
  const rtX=Math.cos(camYaw),rtZ=-Math.sin(camYaw);
  let mx=0,mz=0;
  if(K['KeyW']){mx+=fwdX;mz+=fwdZ;}
  if(K['KeyS']){mx-=fwdX;mz-=fwdZ;}
  if(K['KeyA']){mx-=rtX;mz-=rtZ;}
  if(K['KeyD']){mx+=rtX;mz+=rtZ;}
  if(mx!==0||mz!==0){const len=Math.hypot(mx,mz);mx/=len;mz/=len;velX+=mx*ACCEL*dt*speedMult*streakBoost;velZ+=mz*ACCEL*dt*speedMult*streakBoost;}
  else{velX*=FRICTION;velZ*=FRICTION;}
  const maxVel=SPEED_BASE*speedMult*streakBoost*(dt/16)*1.6;
  const vLen=Math.hypot(velX,velZ);
  if(vLen>maxVel&&vLen>0){velX=velX/vLen*maxVel;velZ=velZ/vLen*maxVel;}
  let nx=myX+velX,nz=myZ+velZ;
  if(!hitsColl(nx,myZ))myX=nx;else velX=0;
  if(!hitsColl(myX,nz))myZ=nz;else velZ=0;
  moveSpeed=Math.hypot(velX,velZ);
  if(moveSpeed>0.0001)walkPhase+=dt*0.02*(0.6+moveSpeed*4);
  if(moveSpeed>0.02&&now-lastStepSnd>(isADS?420:320)){lastStepSnd=now;playStep();}
  if(K['MouseLeft']||K['Space'])doAttack();
  if(myChar){myChar.group.visible=false;myChar.group.position.set(myX,0,myZ);}
  myAngle=camYaw+Math.PI;
  if(Date.now()-lastSent>45){lastSent=Date.now();socket?.emit('move',{x:myX,z:myZ,a:myAngle});}
  checkPickups();
}

let nearbyPickup=null;
function checkPickups(){
  if(Date.now()-pickupCD<100)return;pickupCD=Date.now();nearbyPickup=null;
  for(const[id,pk]of pickupMeshes){if(Math.hypot(myX-pk.x,myZ-pk.z)<2.5){nearbyPickup={id,type:pk.type};break;}}
  const hint=document.getElementById('pickup-hint');
  if(nearbyPickup){
    const isFull=myInventory.length>=7;
    const name=WN[nearbyPickup.type]||nearbyPickup.type.toUpperCase();
    if(isFull){hint.textContent='âš  SLOTS FULL â€” DROP A GUN FIRST [X]';hint.style.color='#ff6633';}
    else{hint.textContent='[E] PICK UP '+name;hint.style.color='#7fff00';}
    hint.classList.add('show');
  }else{hint.classList.remove('show');}
}
function dropWeapon(){
  if(!gameActive||myDead)return;
  const wep=myInventory[myWepIdx];
  if(!wep||['fists','knife','grenade'].includes(wep.key))return;
  socket?.emit('dropWeapon',{idx:myWepIdx});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTHER PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function interpOthers(dt){
  for(const[,op]of otherPlayers){
    if(op.d){op.char.group.visible=false;continue;}
    op.char.group.visible=true;
    op.cx=op.cx===undefined?op.tx:THREE.MathUtils.lerp(op.cx,op.tx,.18);
    op.cz=op.cz===undefined?op.tz:THREE.MathUtils.lerp(op.cz,op.tz,.18);
    op.char.group.position.set(op.cx,0,op.cz);
    op.char.group.rotation.y=op.a;
    if(op.char.armorPlate)op.char.armorPlate.visible=op.ar>0;
    const r=op.h/100;
    op.char.ring.material.color.setHex(r>.5?0x44ff44:r>.25?0xff9900:0xff2200);
    op.char.ring.visible=true;
    const moved=Math.hypot(op.tx-(op.px||op.tx),op.tz-(op.pz||op.tz))>.02;
    if(moved){const t=Date.now()*.008;if(op.char.lL)op.char.lL.rotation.x=Math.sin(t)*.5;if(op.char.lR)op.char.lR.rotation.x=Math.sin(t+Math.PI)*.5;}
    op.px=op.tx;op.pz=op.tz;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EFFECTS â€” REALISTIC BULLETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_P=250;
function spawnMuzzle(x,y,z,col,wkey){
  // Bright muzzle flash light
  const pl=new THREE.PointLight(col,wkey==='sniper'?8:wkey==='shotgun'?6:4,wkey==='sniper'?8:5);
  pl.position.set(x,y,z);scene.add(pl);
  setTimeout(()=>scene.remove(pl),wkey==='sniper'?100:60);
  // Muzzle particle burst
  for(let i=0;i<3&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.08+Math.random()*.06;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.03,3,3),new THREE.MeshBasicMaterial({color:col}));
    m.position.set(x,y,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.03+Math.random()*.05,vz:Math.sin(a)*spd,life:.35});
  }
}

// Realistic bullet trail â€” elongated box instead of sphere
function spawnBulletTrail(x,y,z,color,weapon){
  const isSniper=weapon==='sniper'||weapon==='crossbow';
  const geo=isSniper?new THREE.BoxGeometry(.04,.04,.45):new THREE.BoxGeometry(.03,.03,.22);
  const mat=new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.85});
  const m=new THREE.Mesh(geo,mat);
  m.position.set(x,y,z);
  return m;
}

function spawnBloodAt(x,z){
  for(let i=0;i<7&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.07+Math.random()*.12;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.04+Math.random()*.07,4,4),new THREE.MeshBasicMaterial({color:0x990000}));
    m.position.set(x,.8+Math.random()*.3,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.08+Math.random()*.1,vz:Math.sin(a)*spd,life:.9});
  }
}
function spawnImpactSpark(x,y,z,col){
  for(let i=0;i<5&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.06+Math.random()*.10;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.025,3,3),new THREE.MeshBasicMaterial({color:col||0xffff44}));
    m.position.set(x,y,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.04+Math.random()*.08,vz:Math.sin(a)*spd,life:.4});
  }
}
function spawnFlameParticles(x,z,aim){
  for(let i=0;i<5&&particles.length<MAX_P;i++){
    const a=aim+(Math.random()-.5)*.5,spd=.12+Math.random()*.15;
    const col=Math.random()>.5?0xff4400:0xff8800;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.08+Math.random()*.1,5,5),new THREE.MeshBasicMaterial({color:col}));
    m.position.set(x+Math.sin(aim)*.5,1,z+Math.cos(aim)*.5);scene.add(m);
    particles.push({mesh:m,vx:Math.sin(a)*spd,vy:.02+Math.random()*.08,vz:Math.cos(a)*spd,life:.7,scale:true});
  }
}
function spawnExplosion(x,z,big){
  playBoom(x,z,big);
  screenShake+=big?8:4;
  const pl=new THREE.PointLight(0xff6600,big?12:7,big?18:12);pl.position.set(x,1.5,z);scene.add(pl);
  setTimeout(()=>scene.remove(pl),big?550:380);
  for(let i=0;i<(big?22:12)&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.14+Math.random()*.28;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.07+Math.random()*.11,5,5),new THREE.MeshBasicMaterial({color:Math.random()>.5?0xff4400:0xffaa00}));
    m.position.set(x,1.2,z);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.22+Math.random()*.35,vz:Math.sin(a)*spd,life:.95});
  }
  // Smoke puffs
  for(let i=0;i<(big?5:2)&&particles.length<MAX_P;i++){
    const a=Math.random()*Math.PI*2,spd=.04+Math.random()*.06;
    const m=new THREE.Mesh(new THREE.SphereGeometry(.25+Math.random()*.2,5,5),new THREE.MeshBasicMaterial({color:0x333333,transparent:true,opacity:.45}));
    m.position.set(x+(Math.random()-.5)*1.5,1.5+Math.random()*.5,z+(Math.random()-.5)*1.5);scene.add(m);
    particles.push({mesh:m,vx:Math.cos(a)*spd,vy:.06+Math.random()*.06,vz:Math.sin(a)*spd,life:.8,scale:true,smoke:true});
  }
}
function tickParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vx*=.92;p.vz*=.92;p.vy-=.012;
    p.mesh.position.x+=p.vx;p.mesh.position.y+=p.vy;p.mesh.position.z+=p.vz;
    if(p.mesh.position.y<.02){p.mesh.position.y=.02;p.vy*=-.18;p.vx*=.6;p.vz*=.6;}
    p.life-=dt*.0014;
    if(p.scale&&p.mesh.scale)p.mesh.scale.setScalar(Math.max(0.01,p.life));
    if(p.smoke&&p.mesh.material)p.mesh.material.opacity=p.life*.45;
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}
function tickGrenades(dt){
  for(let i=flyGrenades.length-1;i>=0;i--){
    const g=flyGrenades[i];
    g.timer-=dt;g.vy-=.009;
    g.mesh.position.x+=g.vx;g.mesh.position.y+=g.vy;g.mesh.position.z+=g.vz;
    g.mesh.rotation.x+=.1;
    if(g.mesh.position.y<=.15&&!g.bounced){g.bounced=true;g.vy=Math.abs(g.vy)*.3;g.vx*=.4;g.vz*=.4;}
    if(g.mesh.position.y<0)g.mesh.position.y=0;
    if(g.timer<=0){spawnExplosion(g.mesh.position.x,g.mesh.position.z,false);scene.remove(g.mesh);flyGrenades.splice(i,1);}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ensureAudio(){
  if (audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();masterGain.gain.value=.35;masterGain.connect(audioCtx.destination);
}
function playTone(freq,dur,vol=0.18,type='square'){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(masterGain);
  o.type=type;o.frequency.value=freq;
  g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
  o.start();o.stop(audioCtx.currentTime+dur);
}
function playStep(){if(!audioCtx)return;playTone(60+Math.random()*20,.08,.06,'sine');}
function playBoom(x,z,big){
  if(!audioCtx)return;
  const dist=Math.hypot(x-myX,z-myZ);
  if(dist>55)return;
  const vol=Math.max(.02,big?.35:.20)*(1-dist/55);
  playTone(40,.5,vol,'sawtooth');playTone(80,.3,vol*.6,'sine');
}
function updateAudioListener(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  document.getElementById('hp-fill').style.width=myHp+'%';
  document.getElementById('hp-fill').style.background=myHp>50?'#44ff44':myHp>25?'#ff9900':'#ff2200';
  const ap=myUpgrades.heavy_armor?100:myUpgrades.armor?60:0;
  document.getElementById('armor-fill').style.width=ap+'%';
  document.getElementById('armor-bar-wrap').style.display=ap>0?'block':'none';
  const lr=document.getElementById('livesrow');lr.innerHTML='';
  const maxLives=gameMode==='lms'?1:3;
  for(let i=0;i<maxLives;i++){const p=document.createElement('div');p.className='lpip';p.style.background=i<myLives?'#ff5733':'#333';p.style.boxShadow=i<myLives?'0 0 5px #ff5733':'none';lr.appendChild(p);}
  document.getElementById('money').textContent='ğŸ’° $'+myMoney;
  // Team score
  const ts=document.getElementById('team-score');
  if(gameMode==='tdm'){ts.style.display='block';document.getElementById('ts-r').textContent=teamScore.r||0;document.getElementById('ts-b').textContent=teamScore.b||0;}
  else ts.style.display='none';
  // Zone
  if(gameMode==='lms'){document.getElementById('zone-bar').style.display='block';document.getElementById('zone-bar').textContent=`âš  ZONE: ${Math.round(zoneR)}m`;}
  else document.getElementById('zone-bar').style.display='none';
}
function updateWBar(){
  const bar=document.getElementById('wbar');bar.innerHTML='';
  for(let i=0;i<7;i++){
    const sl=document.createElement('div');sl.className='ws'+(i===myWepIdx?' active':'');
    const num=document.createElement('div');num.className='wnum';num.textContent=i+1;sl.appendChild(num);
    if(myInventory[i]){
      const w=myInventory[i];
      const wi=document.createElement('div');wi.className='wi';wi.textContent=WI[w.key]||'?';
      const wn=document.createElement('div');wn.className='wn';wn.textContent=WN[w.key]||w.key.toUpperCase();
      const wa=document.createElement('div');
      if(w.ammo===Infinity){wa.className='wa';wa.textContent='âˆ';}
      else if(w.key==='grenade'){wa.className='wa '+(w.ammo>0?'':'none');wa.textContent=w.ammo+'x';}
      else{const mx=WMAX[w.key]||1,r=w.ammo/mx;wa.className='wa '+(w.ammo===0?'none':r<.35?'low':'');wa.textContent=w.ammo+'/'+mx;}
      sl.appendChild(wi);sl.appendChild(wn);sl.appendChild(wa);sl.onclick=()=>selectWeapon(i);
    }else{sl.classList.add('empty');}
    bar.appendChild(sl);
  }
}
function updateTimer(){
  const m=~~(matchTimer/60),s=matchTimer%60;
  const el=document.getElementById('timer');
  el.textContent=m+':'+(s<10?'0':'')+s;
  el.style.color=matchTimer<60?'#ff5733':'#7fff00';
}
function addKill(killer,victim,col='#a0d060'){
  const el=document.createElement('div');el.className='km';el.style.borderColor=col;
  el.textContent=victim?killer+' âš” '+victim:killer;
  document.getElementById('kf').appendChild(el);
  setTimeout(()=>el.remove(),4200);
}
function flashHit(){
  const fl=document.getElementById('flash');fl.className='';void fl.offsetWidth;fl.className='pop';
  spawnBloodAt(myX,myZ);
}
let pToastTimer=null;
function showPickupToast(msg){
  const t=document.getElementById('ptost');t.textContent=msg;t.classList.add('show');
  clearTimeout(pToastTimer);pToastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}
let moneyGainTimer=null;
function showMoneyGain(amount,reason){
  const el=document.getElementById('money-gain');
  el.textContent='+$'+amount+' '+reason;el.style.opacity='1';
  clearTimeout(moneyGainTimer);moneyGainTimer=setTimeout(()=>el.style.opacity='0',2000);
}
let streakTimer=null;
function showStreakBanner(msg){
  const el=document.getElementById('streak-banner');el.textContent=msg;el.classList.add('show');
  clearTimeout(streakTimer);streakTimer=setTimeout(()=>el.classList.remove('show'),3000);
}
let respawnIV=null;
function showDeadScreen(){
  document.getElementById('dead-screen').classList.remove('off');
  document.getElementById('lock-ov').classList.add('off');
  let cnt=3;document.getElementById('respawnNum').textContent=cnt;
  document.getElementById('livesLeft').textContent=myLives>0?myLives+' LIVES LEFT':'';
  clearInterval(respawnIV);
  respawnIV=setInterval(()=>{cnt--;document.getElementById('respawnNum').textContent=cnt;if(cnt<=0)clearInterval(respawnIV);},1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLB(open){isLBOpen=open;document.getElementById('lb-ov').classList.toggle('off',!open);if(open)renderLB();}
function renderLB(){
  const rows=document.getElementById('lb-rows');rows.innerHTML='';
  const sorted=[...curLB].sort((a,b)=>b.k-a.k);
  sorted.forEach((r,i)=>{
    const row=document.createElement('div');
    row.className='lbr'+(i===0?' t1':'');
    const teamColor=r.t==='r'?'color:#ff6677':r.t==='b'?'color:#55bbff':'';
    row.innerHTML=`<div class="rank">${i+1}</div><div class="nm" style="${teamColor}">${r.n}</div><div class="kl">${r.k}</div><div class="dt">${r.d}</div><div class="mo">$${r.m}</div>`;
    rows.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleShop(){if(isShopOpen)closeShop();else openShop();}
function openShop(){
  isShopOpen=true;
  document.getElementById('shop-ov').classList.remove('off');
  document.exitPointerLock();
  renderShop();
}
function closeShop(){
  isShopOpen=false;
  document.getElementById('shop-ov').classList.add('off');
  document.getElementById('shop-feedback').textContent='';
  if(gameActive&&!myDead)document.getElementById('lock-ov').classList.remove('off');
}
function renderShop(){
  document.getElementById('shop-money-display').textContent='ğŸ’° $'+myMoney;
  const grid=document.getElementById('shop-items');grid.innerHTML='';
  for(const[key,item]of Object.entries(SHOP_DEFS)){
    const cell=document.createElement('div');
    const owned=myUpgrades[key];
    const locked=item.requires&&!myUpgrades[item.requires];
    const canAfford=myMoney>=item.price;
    cell.className='shop-item'+(owned?' owned':locked?' locked':'');
    cell.innerHTML=`<div class="sname">${item.icon} ${item.name}</div><div class="sdesc">${item.desc}${item.requires?' (Requires '+item.requires.replace('_',' ').toUpperCase()+')':''}</div><div class="sprice${!canAfford&&!owned?' noafford':''}">${owned?'':('$'+item.price)}</div>${owned?'<div class="owned-badge">âœ“ OWNED</div>':''}`;
    if(!owned&&!locked)cell.onclick=()=>socket?.emit('buyItem',{itemKey:key});
    grid.appendChild(cell);
  }
}
document.getElementById('shop-close').addEventListener('click',closeShop);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mmC=document.getElementById('mm'),mmX=mmC.getContext('2d'),MM=130;
function drawMM(){
  mmX.clearRect(0,0,MM,MM);
  mmX.fillStyle='rgba(0,8,0,.88)';mmX.fillRect(0,0,MM,MM);
  const toMM=(x,z)=>({px:((x+62)/124)*MM,py:((z+62)/124)*MM});
  // Zone ring (LMS)
  if(gameMode==='lms'){const cx=MM/2,cy=MM/2,rpx=(zoneR/62)*(MM/2);mmX.strokeStyle='rgba(255,120,50,.85)';mmX.lineWidth=2;mmX.beginPath();mmX.arc(cx,cy,rpx,0,Math.PI*2);mmX.stroke();}
  // Pickups
  for(const[,p]of pickupMeshes){const{px,py}=toMM(p.x,p.z);mmX.fillStyle='#7fff00';mmX.beginPath();mmX.arc(px,py,2,0,Math.PI*2);mmX.fill();}
  // Barrels
  mmX.fillStyle='rgba(255,60,60,.9)';
  for(const[,b]of barrelMeshes){const{px,py}=toMM(b.position.x,b.position.z);mmX.fillRect(px-1.5,py-1.5,3,3);}
  // Others
  for(const[,op]of otherPlayers){
    if(op.d)continue;
    const hasRadar=myUpgrades.radar;
    if(!hasRadar&&Math.hypot((op.cx||op.tx)-myX,(op.cz||op.tz)-myZ)>20)continue;
    const{px,py}=toMM(op.cx||op.tx,op.cz||op.tz);
    const isMate=gameMode==='tdm'&&myTeam&&op.t&&op.t===myTeam;
    mmX.fillStyle=isMate?'#55aaff':'#ff5555';
    mmX.beginPath();mmX.arc(px,py,3,0,Math.PI*2);mmX.fill();
  }
  // Self
  const{px,py}=toMM(myX,myZ);
  mmX.fillStyle='#ffffff';mmX.beginPath();mmX.arc(px,py,4.5,0,Math.PI*2);mmX.fill();
  const faceDir=camYaw+Math.PI,ax=px+Math.sin(faceDir)*9,ay=py+Math.cos(faceDir)*9;
  mmX.strokeStyle='#7fff00';mmX.lineWidth=2;mmX.beginPath();mmX.moveTo(px,py);mmX.lineTo(ax,ay);mmX.stroke();
  mmX.strokeStyle='#1a3a0a';mmX.lineWidth=2;mmX.strokeRect(1,1,MM-2,MM-2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIT MARKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hmTimeout=null;
function showHitMarker(headshot){
  const el=document.getElementById('hitmark');
  el.classList.remove('hm-pop','hm-hs');
  void el.offsetWidth;
  el.classList.add('hm-pop');
  if(headshot)el.classList.add('hm-hs');
  clearTimeout(hmTimeout);hmTimeout=setTimeout(()=>el.classList.remove('hm-pop','hm-hs'),280);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REALISTIC BULLET VISUALS (server-driven, elongated trails)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncBulletVisuals(bArr){
  const seen=new Set();
  for(const b of bArr){
    seen.add(b.i);
    const by=b.y??0.9;
    if(!srvBullets.has(b.i)){
      // Realistic: elongated trail with glowing tip
      const col=b.c||0xffff44;
      const isHeavy=b.w==='sniper'||b.w==='crossbow';
      const trailLen=isHeavy?.55:.22;
      const trailGeo=new THREE.BoxGeometry(.025,.025,trailLen);
      const trailMat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.9});
      const trail=new THREE.Mesh(trailGeo,trailMat);
      // Glowing tip sphere
      const tip=new THREE.Mesh(new THREE.SphereGeometry(.04,4,4),new THREE.MeshBasicMaterial({color:col}));
      const pl=new THREE.PointLight(col,isHeavy?1.5:.8,isHeavy?4:2.5);
      const grp=new THREE.Group();
      grp.add(trail);grp.add(tip);grp.add(pl);
      grp.position.set(b.x,by,b.z);
      scene.add(grp);
      srvBullets.set(b.i,{mesh:grp,prevX:b.x,prevZ:b.z,prevY:by});
    }else{
      const entry=srvBullets.get(b.i);
      const dx=b.x-entry.prevX,dz=b.z-(entry.prevZ||b.z);
      const angle=Math.atan2(dx,dz);
      entry.mesh.rotation.y=angle;
      entry.mesh.position.set(b.x,by,b.z);
      entry.prevX=b.x;entry.prevZ=b.z;entry.prevY=by;
    }
  }
  for(const[id,sb]of srvBullets){if(!seen.has(id)){scene.remove(sb.mesh);srvBullets.delete(id);}}
}

function syncRocketVisuals(rArr){
  const seen=new Set();
  for(const r of rArr){
    seen.add(r.i);
    const ry=r.y??1;
    if(!srvRockets.has(r.i)){
      const g=new THREE.Group();
      const body=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,.4,6),new THREE.MeshLambertMaterial({color:0xcc2200}));
      body.rotation.x=Math.PI/2;g.add(body);
      const nose=new THREE.Mesh(new THREE.ConeGeometry(.07,.12,6),new THREE.MeshLambertMaterial({color:0xff4400}));
      nose.rotation.x=Math.PI/2;nose.position.z=.26;g.add(nose);
      const flame=new THREE.PointLight(0xff6600,3,5);flame.position.z=-.25;g.add(flame);
      // Trail particles via small spheres
      g.position.set(r.x,ry,r.z);scene.add(g);srvRockets.set(r.i,{mesh:g,prevX:r.x,prevZ:r.z});
    }else{
      const entry=srvRockets.get(r.i);
      const dx=r.x-entry.prevX,dz=r.z-entry.prevZ;
      if(Math.hypot(dx,dz)>0.01)entry.mesh.rotation.y=Math.atan2(dx,dz);
      entry.mesh.position.set(r.x,ry,r.z);entry.prevX=r.x;entry.prevZ=r.z;
    }
  }
  for(const[id,rm]of srvRockets){if(!seen.has(id)){scene.remove(rm.mesh);srvRockets.delete(id);}}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET.IO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connect(name,mode){
  socket=io();
  socket.on('connect',()=>socket.emit('join',{name,mode}));

  socket.on('joined',data=>{
    myId=data.playerId;mapName=data.mapName;matchTimer=data.timeLeft;
    gameMode=data.mode||'ffa';myTeam=data.team??null;
    myX=data.spawnX;myZ=data.spawnZ;myAngle=0;
    myInventory=data.inventory;myMoney=data.money;myWepIdx=0;
    myHp=100;myLives=gameMode==='lms'?1:3;
    myDead=false;myElim=false;myKills=0;myDeaths=0;
    myUpgrades={armor:false,heavy_armor:false,speed:false,radar:false};
    speedMult=1.0;streakSpeedEnd=0;airstrikeReady=false;airstrikeMode=false;
    teamScore=data.teamScore||{r:0,b:0};

    buildMap(data.mapName);
    for(const[id]of pickupMeshes)removePickupMesh(id);
    for(const[id]of barrelMeshes)removeBarrelMesh(id);
    for(const pk of data.pickups)if(pk.active)mkPickupMesh(pk);
    for(const br of(data.barrels||[]))if(br.alive)mkBarrelMesh(br);

    if(myChar)scene.remove(myChar.group);
    const myCol=gameMode==='tdm'?(myTeam==='r'?0xff3344:0x3388ff):0x44aa22;
    myChar=buildChar(myCol,true);
    myChar.group.position.set(myX,0,myZ);myChar.group.visible=false;scene.add(myChar.group);
    setCharWep(myChar,myInventory[0]?.key||'fists');
    camPitch=0;camYaw=0;snapCamera();

    document.getElementById('hud').classList.remove('off');
    document.getElementById('mapbadge').textContent=data.mapName.toUpperCase();
    // Mode badge with color
    const mb=document.getElementById('modebadge');
    const modeLabels={ffa:'âš” FREE FOR ALL',tdm:'ğŸ”´ VS ğŸ”µ TEAMS',lms:'ğŸ’€ SURVIVAL'};
    const modeColors={ffa:'#7fff00',tdm:'#ff99aa',lms:'#ff7733'};
    mb.textContent=modeLabels[gameMode]||gameMode.toUpperCase();
    mb.style.color=modeColors[gameMode]||'#7fff00';
    document.getElementById('conn-screen').classList.add('off');
    document.getElementById('lock-ov').classList.remove('off');
    gameActive=true;
    updateHUD();updateWBar();updateTimer();
    addKill('Joined match on '+data.mapName.toUpperCase(),null,'#7fff00');
  });

  socket.on('S',data=>{
    matchTimer=data.T;playerCount=data.PC;curLB=data.LB||[];
    if(data.MO)gameMode=data.MO;
    if(Number.isFinite(data.ZR))zoneR=data.ZR;
    if(data.TS)teamScore=data.TS;
    document.getElementById('pcbadge').textContent='ğŸ‘¤ '+playerCount;
    updateTimer();updateHUD();
    if(isLBOpen)renderLB();
    const seen=new Set();
    for(const pd of data.P){
      if(pd.i===myId){
        if(pd.k>myKills)myKills=pd.k;
        if(pd.l!==undefined)myLives=pd.l;
        airstrikeReady=!!pd.as;continue;
      }
      seen.add(pd.i);
      if(!otherPlayers.has(pd.i)){
        const h=Math.abs(hashStr(pd.i))%360;
        const col=gameMode==='tdm'&&pd.t?(pd.t==='r'?0xff3344:0x3388ff):new THREE.Color().setHSL(h/360,.7,.5).getHex();
        const ch=buildChar(col,false);
        ch.group.position.set(pd.x,0,pd.z);scene.add(ch.group);
        otherPlayers.set(pd.i,{...pd,char:ch,tx:pd.x,tz:pd.z,cx:pd.x,cz:pd.z});
        updateNameTag(ch.nameSprite,pd.n,pd.k,pd.t);
      }else{
        const op=otherPlayers.get(pd.i);
        op.tx=pd.x;op.tz=pd.z;op.a=pd.a;op.h=pd.h;op.l=pd.l;op.d=pd.d;op.k=pd.k;op.ar=pd.ar;op.t=pd.t;
        updateNameTag(op.char.nameSprite,pd.n,pd.k,pd.t);
      }
    }
    for(const[id,op]of otherPlayers){if(!seen.has(id)){scene.remove(op.char.group);otherPlayers.delete(id);}}
    syncBulletVisuals(data.B||[]);
    syncRocketVisuals(data.R||[]);
    syncBarrels(data.BR||[]);
  });

  socket.on('hit',data=>{myHp=data.hp;flashHit();updateHUD();});
  socket.on('pHurt',data=>{const op=otherPlayers.get(data.id);if(op)op.h=data.hp;});
  socket.on('hitMarker',data=>showHitMarker(data?.headshot));

  socket.on('kill',data=>{
    const suffix=(data.hs?' ğŸ’¥HEADSHOT':'')+(data.streak>=3?' ğŸ”¥Ã—'+data.streak:'');
    addKill(data.kn,data.vn+suffix,data.hs?'#ffd700':'#a0d060');
    if(data.ki===myId){myKills++;updateHUD();}
    spawnBloodAt(0,0);
  });

  socket.on('bulletImpact',data=>{
    spawnImpactSpark(data.x,data.y||1,data.z,0xffff44);
  });

  socket.on('earnMoney',data=>{myMoney=data.total;showMoneyGain(data.amount,data.reason);updateHUD();if(isShopOpen)renderShop();});

  socket.on('youDied',data=>{
    myDead=true;myLives=data.lives;myDeaths++;
    if(myChar)myChar.group.visible=false;airstrikeMode=false;
    document.getElementById('ch').classList.remove('airstrike');
    showDeadScreen();updateHUD();
  });

  socket.on('respawned',data=>{
    myX=data.x;myZ=data.z;myDead=false;myHp=100;
    myInventory=data.inventory||myInventory;myMoney=data.money||myMoney;
    if(myWepIdx>=myInventory.length)myWepIdx=0;
    if(myChar){myChar.group.position.set(myX,0,myZ);myChar.group.visible=false;}
    stopADS();snapCamera();
    document.getElementById('dead-screen').classList.add('off');
    document.getElementById('lock-ov').classList.remove('off');
    updateHUD();updateWBar();
  });

  socket.on('eliminated',data=>{
    myElim=true;myDead=true;
    document.getElementById('dead-screen').classList.add('off');
    document.getElementById('elim-screen').classList.remove('off');
    document.getElementById('elimStats').innerHTML=`KILLS: ${data.kills||myKills}<br>DEATHS: ${data.deaths||myDeaths}<br><br><span style="color:#4a7a3a">You can still spectate</span>`;
  });

  socket.on('shopResult',data=>{
    const fb=document.getElementById('shop-feedback');
    if(data.ok){
      myMoney=data.money;
      if(data.upgrade){myUpgrades[data.upgrade]=true;if(data.upgrade==='speed')speedMult=1.25;if(myChar&&myChar.armorPlate)myChar.armorPlate.visible=myUpgrades.armor||myUpgrades.heavy_armor;}
      if(data.inventory)myInventory=data.inventory;
      if(data.hp)myHp=data.hp;
      fb.style.color='#7fff00';fb.textContent='âœ“ '+SHOP_DEFS[data.itemKey]?.name+' purchased!';
      updateHUD();updateWBar();renderShop();
    }else{fb.style.color='#ff5533';fb.textContent='âœ— '+data.reason;}
  });

  socket.on('pickupOK',data=>{
    if(data.inventory)myInventory=data.inventory;
    if(myWepIdx>=myInventory.length)myWepIdx=Math.max(0,myInventory.length-1);
    showPickupToast(data.msg||'PICKED UP');updateWBar();
    if(data.id!==null)selectWeapon(myWepIdx);
  });
  socket.on('pickupGone',data=>removePickupMesh(data.id));
  socket.on('pickupBack',data=>{if(!pickupMeshes.has(data.id)&&data.x!==undefined)mkPickupMesh({id:data.id,type:data.type,x:data.x,z:data.z});});
  socket.on('grenadeFly',data=>{if(!data||!data.ox)return;spawnClientGrenade(data.ox,1.2,data.oz,data.vx,data.vy||.18,data.vz);});
  socket.on('explosion',data=>spawnExplosion(data.x,data.z,data.big));

  socket.on('teamScore',data=>{teamScore=data;updateHUD();});

  socket.on('matchEnd',data=>{
    gameActive=false;stopADS();
    document.getElementById('hud').classList.add('off');
    closeShop();openLB(false);
    document.getElementById('end-screen').classList.remove('off');
    document.getElementById('endWinner').textContent='ğŸ† '+(data.winner||'Match Over');
    const tb=document.querySelector('#endTable tbody');tb.innerHTML='';
    (data.results||[]).forEach((r,i)=>{
      const tr=document.createElement('tr');if(i===0)tr.className='gold';
      const team=r.team==='r'?'ğŸ”´ ':r.team==='b'?'ğŸ”µ ':'';
      tr.innerHTML=`<td>${i+1}</td><td>${team}${r.name}</td><td style="color:#7fff00">${r.kills}</td><td style="color:#ff5733">${r.deaths}</td><td style="color:#ffd700">$${r.money}</td>`;
      tb.appendChild(tr);
    });
    document.exitPointerLock();
  });

  socket.on('barrelGone',data=>{if(data?.id!==undefined)removeBarrelMesh(data.id);});
  socket.on('supplyDrop',data=>{showPickupToast('ğŸ“¦ SUPPLY DROP INCOMING!');addKill('SUPPLY DROP INCOMING',null,'#00ffaa');});
  socket.on('airstrike',data=>{addKill('âœˆ AIRSTRIKE',data?.by||'','#ffd700');});

  socket.on('streakReward',data=>{
    if(!data?.type)return;
    if(data.type==='speed'){streakSpeedEnd=Date.now()+(data.ms||12000);showStreakBanner('âš¡ TRIPLE KILL â€” SPEED BOOST!');}
    else if(data.type==='airstrike'){airstrikeReady=true;showStreakBanner('âœˆ PENTA KILL â€” AIRSTRIKE READY! [Z]');}
    else if(data.type==='minigun'){showStreakBanner('ğŸ”¥ LEGENDARY â€” MINIGUN GRANTED!');}
  });

  // â”€â”€ MAP VOTE â”€â”€
  let myVote=null,voteChoices=[],voteTimerIV=null;

  socket.on('voteStart',data=>{
    voteChoices=data.choices;myVote=null;
    document.getElementById('vote-ov').classList.remove('off');
    document.getElementById('vote-title').textContent='ğŸ—º VOTE FOR NEXT MAP';
    document.getElementById('vote-sub').textContent='CLICK TO VOTE â€” MAJORITY WINS';
    document.getElementById('vote-mode-label').textContent='CONTINUING IN MODE: '+(data.mode||gameMode).toUpperCase();
    renderVote(data.choices,{});
    let secs=data.seconds;
    document.getElementById('vote-timer-fill').style.width='100%';
    document.getElementById('vote-timer-txt').textContent=secs+'s';
    clearInterval(voteTimerIV);
    voteTimerIV=setInterval(()=>{
      secs--;
      const pct=Math.max(0,(secs/data.seconds)*100);
      document.getElementById('vote-timer-fill').style.width=pct+'%';
      document.getElementById('vote-timer-txt').textContent=Math.max(0,secs)+'s';
      if(secs<=0)clearInterval(voteTimerIV);
    },1000);
  });

  socket.on('voteUpdate',data=>renderVote(voteChoices,data.votes));

  socket.on('voteEnd',data=>{
    clearInterval(voteTimerIV);
    document.getElementById('vote-title').textContent='ğŸ—º NEXT MAP: '+data.winner.toUpperCase();
    document.getElementById('vote-sub').textContent='RESTARTING IN SAME MODE...';
    document.getElementById('vote-timer-fill').style.width='0%';
    // Save mode to sessionStorage so reload picks it up
    sessionStorage.setItem('fdm_mode',gameMode);
    sessionStorage.setItem('fdm_autorejoin','1');
    setTimeout(()=>location.reload(),3000);
  });

  function renderVote(choices,votes){
    const total=Object.values(votes).reduce((a,b)=>a+b,0)||1;
    const cards=document.getElementById('vote-cards');cards.innerHTML='';
    const mapEmoji={forest:'ğŸŒ²',city:'ğŸ™',warehouse:'ğŸ­',desert:'ğŸœ',arctic:'â„',rooftop:'ğŸ—'};
    choices.forEach(map=>{
      const v=votes[map]||0,pct=Math.round((v/total)*100);
      const card=document.createElement('div');
      card.className='vc'+(myVote===map?' voted':'');
      card.innerHTML=`<div class="vc-name">${mapEmoji[map]||'ğŸ—º'} ${map.toUpperCase()}</div><div class="vc-votes">${v}</div><div class="vc-bar" style="width:${pct}%"></div><div class="vc-pct">${pct}%</div>`;
      if(!myVote){card.addEventListener('click',()=>{myVote=map;socket?.emit('vote',{map});renderVote(choices,votes);});}
      cards.appendChild(card);
    });
  }

  socket.on('pJoin',data=>addKill(data.name+' JOINED',null,'#7fff00'));
  socket.on('pLeave',data=>{
    addKill(data.name+' LEFT',null,'#ff5555');
    const op=otherPlayers.get(data.id);if(op){scene.remove(op.char.group);otherPlayers.delete(data.id);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTs=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(ts-lastTs,60);lastTs=ts;
  if(!gameActive){renderer.render(scene,camera);return;}
  processMove(dt);
  updateCamera(dt);
  applyTimeOfDay();
  tickWeather(dt);
  updateAudioListener();
  interpOthers(dt);
  animPickups();
  tickGrenades(dt);
  tickParticles(dt);
  drawMM();
  renderer.render(scene,camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hashStr(s){let h=0;for(let i=0;i<s.length;i++)h=(Math.imul(31,h)+s.charCodeAt(i))|0;return h;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('joinBtn').addEventListener('click',()=>{
  const name=document.getElementById('nameInput').value.trim()||'Soldier';
  sessionStorage.setItem('fdm_mode',selectedMode);
  document.getElementById('join-screen').classList.add('off');
  document.getElementById('conn-screen').classList.remove('off');
  ensureAudio();
  connect(name,selectedMode);
});
document.getElementById('nameInput').addEventListener('keydown',e=>{if(e.code==='Enter')document.getElementById('joinBtn').click();});
document.getElementById('replayBtn').addEventListener('click',()=>location.reload());
document.getElementById('lock-ov').addEventListener('click',()=>{ensureAudio();renderer.domElement.requestPointerLock();});

// Auto-rejoin after vote (same mode, same name)
if(sessionStorage.getItem('fdm_autorejoin')==='1'){
  sessionStorage.removeItem('fdm_autorejoin');
  const savedMode=sessionStorage.getItem('fdm_mode')||'ffa';
  selectedMode=savedMode;
  document.querySelectorAll('.mode-card').forEach(c=>{c.classList.toggle('selected',c.dataset.mode===savedMode);});
  // Give the page a moment to load, then auto-join
  setTimeout(()=>{
    const name='Soldier';
    document.getElementById('join-screen').classList.add('off');
    document.getElementById('conn-screen').classList.remove('off');
    ensureAudio();
    connect(name,savedMode);
  },800);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
